<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Compact Class Performance Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons (for the UI) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Enforce full viewport height and prevent main page scrolling */
        html, body { 
            height: 100%;
            min-height: 100vh;
            overflow: hidden; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9; 
            display: flex;
            flex-direction: column;
        }

        /* Utility classes for tiny text used in the Class Cards */
        .text-4xs {
            font-size: 0.5rem; /* ~8px */
        }
        .text-3xs {
            font-size: 0.55rem; /* ~8.8px */
        }

        /* General Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto; /* Allow scrolling for tall content */
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 550px;
            max-height: 90vh; /* Limit height */
            overflow-y: auto; /* Allow scrolling within the modal content */
        }

        /* Specific styles for the Report Input Modal */
        #report-modal .modal-content {
            width: 450px;
        }
        
        /* Specific styles for the Settings Modal */
        #settings-modal .modal-content {
            width: 800px;
            max-width: 95%;
            padding: 0; /* No padding on container, padding is inside tabs */
        }

        .tab-button.active {
            border-color: #0d9488; /* Emerald-600 */
            color: #0d9488;
            font-weight: 600;
        }

        /* Custom progress bar */
        .progress-bar-container {
            height: 6px;
            border-radius: 9999px;
            background-color: #e5e7eb; /* Gray-200 */
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        
    </style>
</head>
<body class="antialiased">

    <!-- Global State -->
    <script>
        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- FIREBASE IMPORTS WILL BE DYNAMICALLY HANDLED IN initializeFirebase ---
    </script>

    <!-- 1. HEADER & CONTROLS -->
    <header class="flex-shrink-0 bg-white shadow-lg p-3 md:p-4 z-10 sticky top-0">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
            <!-- School Info & Logo -->
            <div id="school-info-display" class="flex items-center space-x-3 w-full sm:w-auto">
                <div id="school-logo-preview" class="w-10 h-10 bg-gray-200 flex items-center justify-center rounded-full overflow-hidden text-xl font-bold text-gray-600 transition duration-300">
                    <span id="school-logo-text">T.</span>
                    <img id="school-logo-img" src="" alt="School Logo" class="object-cover w-full h-full hidden" onerror="this.classList.add('hidden'); document.getElementById('school-logo-text').classList.remove('hidden');">
                </div>
                <div class="text-left">
                    <h1 id="school-name-display" class="text-lg font-extrabold text-gray-800 leading-tight">...</h1>
                    <p id="school-address-display" class="text-xs text-gray-500 hidden md:block">...</p>
                </div>
            </div>

            <!-- Date Picker & Selected Date Display -->
            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full sm:w-auto">
                <div class="text-center md:text-right">
                    <p class="text-sm font-medium text-gray-600">Selected Report Date:</p>
                    <p id="selected-date-display" class="text-xl font-bold text-emerald-600">--/--/----</p>
                </div>
                
                <input type="date" id="date-picker" 
                       class="px-3 py-2 text-base border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition w-full md:w-auto cursor-pointer"
                       onchange="app.setDate(this.value)">
            </div>

            <!-- Settings & Auth -->
            <div class="flex space-x-2 w-full sm:w-auto justify-end">
                <!-- Settings Button -->
                <button onclick="app.openSettingsModal()" 
                        class="p-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition shadow-md hover:shadow-lg active:scale-95">
                    <i class="ph-fill ph-gear text-xl"></i>
                </button>
                <!-- Auth/User Button -->
                <button id="auth-button" onclick="app.toggleAuthMenu(event)" 
                        class="relative p-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full transition shadow-md hover:shadow-lg active:scale-95">
                    <i id="auth-icon" class="ph-fill ph-user text-xl"></i>
                    <div id="auth-menu" class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl hidden z-20">
                        <p id="user-id-display" class="p-3 text-xs text-gray-500 break-words border-b">...</p>
                        <button onclick="app.signInWithGoogle(); app.toggleAuthMenu(event)" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                            <i class="ph-fill ph-google-logo text-lg text-red-500"></i>
                            <span>Sign in with Google</span>
                        </button>
                        <button onclick="app.signOutUser(); app.toggleAuthMenu(event)" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2 hidden" id="sign-out-button">
                            <i class="ph-fill ph-sign-out text-lg text-gray-500"></i>
                            <span>Sign Out</span>
                        </button>
                        <button onclick="app.copyUserId(); app.toggleAuthMenu(event)" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                            <i class="ph-fill ph-copy text-lg text-blue-500"></i>
                            <span>Copy User ID</span>
                        </button>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- 2. MAIN DASHBOARD CONTENT -->
    <main class="flex-grow overflow-y-auto p-4 md:p-6">
        <div id="tracker-dashboard" class="max-w-7xl mx-auto space-y-8">
            <!-- Content will be rendered here by renderDashboard() -->
            <p id="loading-indicator" class="text-center text-gray-500 py-12">
                <i class="ph-bold ph-spinner-gap animate-spin text-3xl block mx-auto"></i>
                Loading configuration and data...
            </p>
            <p id="no-config-message" class="text-center text-gray-500 py-12 hidden">
                <i class="ph-bold ph-gear-six text-3xl block mx-auto text-yellow-500"></i>
                School configuration is empty. Please open <button onclick="app.openSettingsModal()" class="text-emerald-600 font-semibold hover:underline">Settings</button> to add departments and classes.
            </p>
        </div>
    </main>

    <!-- 3. MODALS -->

    <!-- Modal Base Structure -->
    <div id="modal-base-template" class="modal-overlay hidden">
        <div class="modal-content relative">
            <button onclick="app.closeModal(this.closest('.modal-overlay').id)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition">
                <i class="ph-bold ph-x-circle text-2xl"></i>
            </button>
            <div id="modal-content-wrapper">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- 3.1 Report Input Modal -->
    <div id="report-modal" class="modal-overlay hidden">
        <div class="modal-content relative">
            <button onclick="app.closeModal('report-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition">
                <i class="ph-bold ph-x-circle text-2xl"></i>
            </button>
            <div id="report-content-wrapper">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Report Entry</h2>
                <p class="text-sm text-gray-500 mb-6">Enter metrics for <span id="report-modal-class-name" class="font-semibold text-emerald-600"></span> on <span id="report-modal-date" class="font-semibold"></span>.</p>
                
                <input type="hidden" id="report-modal-class-id">
                
                <div class="space-y-4">
                    <!-- Total Strength -->
                    <div>
                        <label for="report-total" class="block text-sm font-medium text-gray-700">Total Class Strength</label>
                        <input type="number" id="report-total" oninput="app.recalculateDCS()" min="0" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                    </div>

                    <!-- Present Today -->
                    <div>
                        <label for="report-present" class="block text-sm font-medium text-gray-700">Present Today</label>
                        <input type="number" id="report-present" oninput="app.recalculateDCS()" min="0" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                    </div>

                    <!-- PR Brought -->
                    <div>
                        <label for="report-pr-brought" class="block text-sm font-medium text-gray-700">Progress Reports (PR) Brought</label>
                        <input type="number" id="report-pr-brought" oninput="app.recalculateDCS()" min="0" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                    </div>

                    <!-- PR Signed -->
                    <div>
                        <label for="report-pr-signed" class="block text-sm font-medium text-gray-700">Progress Reports (PR) Signed</label>
                        <input type="number" id="report-pr-signed" oninput="app.recalculateDCS()" min="0" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                    </div>
                </div>

                <!-- DCS Display -->
                <div class="mt-6 p-4 bg-emerald-50 border-l-4 border-emerald-500 rounded-r-lg flex justify-between items-center">
                    <p class="text-sm font-medium text-emerald-800">Daily Class Score (DCS)</p>
                    <p id="report-dcs-display" class="text-3xl font-extrabold text-emerald-600">--%</p>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <button onclick="app.deleteReportEntry()" id="delete-report-button"
                            class="py-2 px-4 border border-red-500 text-red-600 rounded-lg hover:bg-red-50 transition font-medium text-sm shadow-md hidden">
                        <i class="ph-fill ph-trash-simple text-lg mr-1"></i> Delete Report
                    </button>
                    <button onclick="app.updateReportEntry()" id="save-report-button"
                            class="ml-auto py-3 px-6 bg-emerald-600 text-white font-semibold rounded-lg shadow-xl hover:bg-emerald-700 transition active:scale-95">
                        <i class="ph-fill ph-floppy-disk text-lg mr-2"></i> Save Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3.2 Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content relative">
            <button onclick="app.closeModal('settings-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 z-10 p-2 bg-white rounded-full transition">
                <i class="ph-bold ph-x-circle text-2xl"></i>
            </button>
            <div id="settings-content-wrapper">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-4 px-6 pt-4" aria-label="Tabs">
                        <button id="tab-school-info" onclick="app.showSettingsTab('school-info')" class="tab-button active shrink-0 px-3 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition">
                            School Info
                        </button>
                        <button id="tab-departments" onclick="app.showSettingsTab('departments')" class="tab-button shrink-0 px-3 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition">
                            Departments & Classes
                        </button>
                    </nav>
                </div>

                <div class="p-6 h-full overflow-y-auto">
                    
                    <!-- School Information Tab -->
                    <div id="school-info-tab" class="space-y-6">
                        <h3 class="text-xl font-bold text-gray-800">School Information</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Name -->
                            <div>
                                <label for="config-schoolName" class="block text-sm font-medium text-gray-700">School Name</label>
                                <input type="text" id="config-schoolName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3" placeholder="e.g., The Academy of Excellence">
                            </div>
                            <!-- Logo Text -->
                            <div>
                                <label for="config-schoolLogoText" class="block text-sm font-medium text-gray-700">Logo Text (Fallback)</label>
                                <input type="text" id="config-schoolLogoText" maxlength="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3" placeholder="e.g., T.">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Address -->
                            <div>
                                <label for="config-schoolAddress" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="config-schoolAddress" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3" placeholder="e.g., 123 Learning Lane">
                            </div>
                            <!-- Phone -->
                            <div>
                                <label for="config-schoolPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" id="config-schoolPhone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3" placeholder="e.g., +1-555-1234">
                            </div>
                        </div>

                        <!-- Website -->
                        <div>
                            <label for="config-schoolWebsite" class="block text-sm font-medium text-gray-700">Website URL</label>
                            <input type="url" id="config-schoolWebsite" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-3" placeholder="e.g., https://example.com">
                        </div>

                        <!-- Logo Image Upload -->
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700 mb-2">School Logo Image</label>
                            <div class="flex items-center space-x-4">
                                <input type="file" id="config-schoolLogoFile" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition">
                                <button onclick="document.getElementById('config-schoolLogoFile').value = ''; app.updateLogoPreview()"
                                        class="text-red-500 hover:text-red-700 text-sm font-medium transition">
                                    Clear Image
                                </button>
                                <p id="logo-status" class="text-xs text-gray-500 ml-auto"></p>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Only Google-signed-in users can save an uploaded image logo.</p>
                        </div>
                    </div>

                    <!-- Departments & Classes Tab -->
                    <div id="departments-tab" class="space-y-6 hidden">
                        <h3 class="text-xl font-bold text-gray-800 flex justify-between items-center">
                            <span>Manage Departments and Classes</span>
                            <button onclick="app.addDepartment()" class="py-2 px-4 bg-emerald-600 text-white font-medium rounded-lg shadow-md hover:bg-emerald-700 transition active:scale-95 text-sm">
                                <i class="ph-fill ph-plus-circle text-lg mr-1"></i> Add Department
                            </button>
                        </h3>
                        
                        <div id="departments-list" class="space-y-4">
                            <!-- Department blocks will be rendered here by renderDepartmentsInSettings() -->
                        </div>
                        <p id="no-departments-message" class="text-center text-gray-500 py-4 hidden">No departments added yet.</p>
                    </div>

                    <!-- Save Button (Sticky Footer) -->
                    <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 flex justify-end shadow-inner">
                        <p id="save-status" class="text-sm font-medium text-red-500 mr-4 self-center hidden">Must be signed in with Google to save configuration.</p>
                        <button onclick="app.saveConfig()" id="save-config-button"
                                class="py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-xl hover:bg-blue-700 transition active:scale-95 disabled:opacity-50" disabled>
                            <i class="ph-fill ph-floppy-disk text-lg mr-2"></i> Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3.3 Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content relative w-96">
            <div id="confirm-content-wrapper" class="text-center">
                <i class="ph-fill ph-warning-circle text-5xl text-yellow-500 mb-4"></i>
                <h2 class="text-xl font-bold text-gray-800 mb-2" id="confirm-title">Confirm Action</h2>
                <p class="text-sm text-gray-600 mb-6" id="confirm-message">Are you sure you want to proceed with this action? It cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel-button" class="py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium">
                        Cancel
                    </button>
                    <button id="confirm-ok-button" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition active:scale-95">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 4. JAVASCRIPT LOGIC -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            GoogleAuthProvider, signInWithPopup, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, setDoc, runTransaction, collection, 
            query, where, getDoc, getDocs, deleteDoc, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        setLogLevel('Debug'); // Enable Firestore logging

        // --- CORE APPLICATION STATE ---
        let db, auth, storage;
        let userId = 'anon';
        let isAuthReady = false;
        let config = { 
            schoolInfo: {}, 
            departments: [] 
        };
        let dailyReports = {};
        let accumulatedScores = {};
        
        let selectedDate = formatDate(new Date());

        // --- UTILITY FUNCTIONS ---

        /** Generates a simple slug from a string (e.g., "1A - Girls" -> "1a-girls") */
        function slugify(text) {
            return text.toString().toLowerCase()
                .trim()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        /** Formats a Date object to YYYY-MM-DD string */
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        /** Calculates the Daily Class Score (DCS) percentage */
        function calculateDCS(total, present, prBrought, prSigned) {
            if (total === 0) return 0;

            const presentP = present / total;
            const prBroughtP = prBrought / total;
            const prSignedP = prSigned / total;

            // DCS = (Present * 50%) + (PR Brought * 25%) + (PR Signed * 25%)
            const dcs = (presentP * 0.5) + (prBroughtP * 0.25) + (prSignedP * 0.25);
            return Math.min(100, Math.round(dcs * 100)); // Cap at 100%
        }

        /** Custom confirmation/alert dialog replacement */
        function customConfirm(title, message, isDestructive = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const okButton = document.getElementById('confirm-ok-button');

                titleEl.textContent = title;
                messageEl.textContent = message;

                okButton.className = isDestructive 
                    ? 'py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition active:scale-95' 
                    : 'py-2 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition active:scale-95';

                const handleCancel = () => {
                    appInterface.closeModal('confirm-modal');
                    resolve(false);
                };

                const handleOk = () => {
                    appInterface.closeModal('confirm-modal');
                    resolve(true);
                };

                document.getElementById('confirm-cancel-button').onclick = handleCancel;
                okButton.onclick = handleOk;

                appInterface.openModal('confirm-modal');
            });
        }
        
        /** Retry function with exponential backoff for API calls */
        async function retryFetch(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        // --- FIREBASE INITIALIZATION & AUTH ---

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                // 1. Initial Auth Check and Sign-in
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch(err => {
                            console.error("Custom token sign-in failed:", err);
                            signInAnonymously(auth); // Fallback to anonymous
                        });
                } else {
                    signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        if (user.isAnonymous) {
                            document.getElementById('auth-icon').classList.replace('ph-user', 'ph-user-gear');
                            document.getElementById('sign-out-button').classList.add('hidden');
                        } else {
                            document.getElementById('auth-icon').classList.replace('ph-user-gear', 'ph-google-logo');
                            document.getElementById('sign-out-button').classList.remove('hidden');
                            document.getElementById('save-config-button').disabled = false;
                            document.getElementById('save-status').classList.add('hidden');
                        }
                    } else {
                        userId = 'anon'; // Should not happen with anonymous sign-in fallback
                    }
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    isAuthReady = true;
                    // Once Auth is ready, start listening for data
                    setupDataListeners();
                });

                // 3. Set up Date Picker
                const today = formatDate(new Date());
                document.getElementById('date-picker').setAttribute('max', today);
                document.getElementById('date-picker').value = today;
                appInterface.setDate(today);

            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                console.log("Google Sign-In successful.");
            } catch (error) {
                console.error("Google Sign-In failed:", error.code, error.message);
                // Handle different error codes if needed (e.g., popup closed by user)
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                // After sign out, sign in anonymously as fallback
                await signInAnonymously(auth);
                document.getElementById('save-config-button').disabled = true;
                document.getElementById('save-status').classList.remove('hidden');
                console.log("Signed out and signed in anonymously.");
            } catch (error) {
                console.error("Sign Out failed:", error);
            }
        }
        
        // --- DATA PATHS ---
        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/config/schoolConfig`;
        const REPORTS_COLLECTION_PATH = `artifacts/${appId}/public/data/daily_attendance_reports`;
        const ACCUMULATED_SCORES_COLLECTION_PATH = `artifacts/${appId}/public/data/accumulated_class_scores`;
        const STORAGE_LOGO_PATH = `artifacts/${appId}/school_logo.png`;


        // --- FIREBASE LISTENERS ---
        
        function setupDataListeners() {
            if (!db || !isAuthReady) return;

            // 1. Config Listener
            onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    config = docSnap.data().config || { schoolInfo: {}, departments: [] };
                    console.log("Configuration updated.");
                } else {
                    config = { schoolInfo: {}, departments: [] };
                    console.log("Configuration document not found. Using default empty config.");
                }
                updateSchoolInfoUI();
                renderDashboard();
                renderDepartmentsInSettings();
            }, (error) => {
                console.error("Error listening to config:", error);
            });

            // 2. Accumulated Scores Listener
            onSnapshot(collection(db, ACCUMULATED_SCORES_COLLECTION_PATH), (querySnapshot) => {
                accumulatedScores = {};
                querySnapshot.forEach((doc) => {
                    accumulatedScores[doc.id] = doc.data();
                });
                console.log("Accumulated scores updated.");
                renderDashboard();
            }, (error) => {
                console.error("Error listening to accumulated scores:", error);
            });

            // 3. Daily Reports Listener (for the selected date)
            onSnapshot(doc(db, REPORTS_COLLECTION_PATH, selectedDate), (docSnap) => {
                dailyReports = docSnap.exists() ? docSnap.data() : {};
                console.log(`Daily reports for ${selectedDate} updated.`);
                renderDashboard();
            }, (error) => {
                console.error(`Error listening to daily reports for ${selectedDate}:`, error);
            });
        }
        
        // --- UI RENDERING FUNCTIONS ---

        function updateSchoolInfoUI() {
            const info = config.schoolInfo || {};
            const nameEl = document.getElementById('school-name-display');
            const addrEl = document.getElementById('school-address-display');
            const logoTextEl = document.getElementById('school-logo-text');
            const logoImgEl = document.getElementById('school-logo-img');

            nameEl.textContent = info.name || 'School Tracker';
            addrEl.textContent = info.address || 'Address: N/A';
            
            // Logo logic
            const logoText = info.logoText || 'T.';
            logoTextEl.textContent = logoText;
            
            if (info.logoUrl) {
                logoImgEl.src = info.logoUrl;
                logoImgEl.classList.remove('hidden');
                logoTextEl.classList.add('hidden');
                logoImgEl.onerror = function() {
                    logoImgEl.classList.add('hidden');
                    logoTextEl.classList.remove('hidden');
                }
            } else {
                logoImgEl.classList.add('hidden');
                logoTextEl.classList.remove('hidden');
            }
        }

        function renderDashboard() {
            const dashboard = document.getElementById('tracker-dashboard');
            dashboard.innerHTML = ''; // Clear existing content
            document.getElementById('loading-indicator').classList.add('hidden');
            
            if (config.departments.length === 0) {
                document.getElementById('no-config-message').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-config-message').classList.add('hidden');
            }

            // Iterate through departments and render sections and classes
            config.departments.forEach(dept => {
                dashboard.innerHTML += `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 border-b-2 border-emerald-300 pb-2">${dept.name}</h2>
                        <div id="dept-${dept.id}-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <!-- Class cards go here -->
                        </div>
                    </div>
                `;
                
                const grid = document.getElementById(`dept-${dept.id}-grid`);
                
                if (!dept.classes || dept.classes.length === 0) {
                     grid.innerHTML = `<p class="text-gray-500 col-span-full">No classes configured for this department.</p>`;
                     return;
                }

                dept.classes.forEach(cls => {
                    const classId = slugify(`${cls.name}-${cls.type}`);
                    const report = dailyReports[classId];
                    const accScore = accumulatedScores[classId] || { averageScore: 0, daysCount: 0 };
                    
                    const score = report ? report.dcs : 0;
                    const status = report ? 'Reported' : 'Enter Report';
                    const statusColor = report ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700';

                    // Determine overall performance color based on cumulative average
                    let avgColor = 'border-gray-300'; // Default
                    if (accScore.averageScore >= 90) {
                        avgColor = 'border-emerald-500'; // Excellent
                    } else if (accScore.averageScore >= 80) {
                        avgColor = 'border-blue-500'; // Good
                    } else if (accScore.averageScore >= 70) {
                        avgColor = 'border-amber-500'; // Fair
                    } else if (accScore.averageScore > 0) {
                        avgColor = 'border-red-500'; // Poor
                    }

                    const cardHtml = `
                        <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-[1.01] border-l-8 ${avgColor} flex flex-col justify-between">
                            
                            <!-- Top Row: Class Name & Cumulative Score -->
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-gray-800 leading-tight">${cls.name} <span class="text-sm font-medium text-gray-500">(${cls.type.charAt(0)})</span></h3>
                                    <p class="text-xs text-gray-400 mt-0.5">${dept.name}</p>
                                </div>
                                <div class="text-right ml-4">
                                    <p class="text-3xl font-extrabold text-gray-800 leading-none">${accScore.averageScore.toFixed(0)}<span class="text-lg font-bold">%</span></p>
                                    <p class="text-4xs text-gray-500 mt-1">AVG. (${accScore.daysCount} days)</p>
                                </div>
                            </div>
                            
                            <!-- Today's Report Status -->
                            <div class="mb-3">
                                <div class="flex justify-between items-center text-xs font-medium text-gray-500 mb-1">
                                    <span>Today's DCS</span>
                                    <span>${score}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${score >= 70 ? 'bg-emerald-500' : score > 0 ? 'bg-red-500' : 'bg-gray-400'}" 
                                         style="width: ${score}%"></div>
                                </div>
                            </div>

                            <!-- Metrics Summary and Action Button -->
                            <div class="grid grid-cols-4 gap-2 text-center text-3xs font-medium text-gray-500 border-t pt-3">
                                <div><span class="text-gray-700 font-bold block text-sm">${report?.total ?? '--'}</span>Total</div>
                                <div><span class="text-gray-700 font-bold block text-sm">${report?.present ?? '--'}</span>Pres.</div>
                                <div><span class="text-gray-700 font-bold block text-sm">${report?.prBrought ?? '--'}</span>PR Brt.</div>
                                <div><span class="text-gray-700 font-bold block text-sm">${report?.prSigned ?? '--'}</span>PR Sgn.</div>
                            </div>

                            <button onclick="app.openReportModal('${classId}', '${cls.name}', '${cls.type}')"
                                    class="mt-4 w-full py-2 ${statusColor} rounded-lg text-sm font-semibold transition hover:opacity-80 active:scale-[0.98]">
                                <i class="ph-bold ph-pencil-simple text-sm mr-1"></i> ${status}
                            </button>
                        </div>
                    `;
                    grid.innerHTML += cardHtml;
                });
            });
        }
        
        function renderDepartmentsInSettings() {
            const list = document.getElementById('departments-list');
            list.innerHTML = ''; // Clear
            
            if (config.departments.length === 0) {
                document.getElementById('no-departments-message').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-departments-message').classList.add('hidden');
            }

            config.departments.forEach((dept, deptIndex) => {
                // Department Wrapper
                const deptDiv = document.createElement('div');
                deptDiv.className = 'border border-gray-200 rounded-xl shadow-sm overflow-hidden';
                deptDiv.id = `dept-config-${dept.id}`;
                
                // Department Header
                deptDiv.innerHTML = `
                    <div class="p-4 bg-gray-50 flex justify-between items-center space-x-4">
                        <div class="flex items-center space-x-2 w-3/5">
                            <i class="ph-fill ph-book-open text-xl text-emerald-600 shrink-0"></i>
                            <input type="text" value="${dept.name}" oninput="app.updateDepartmentName('${dept.id}', this.value)"
                                   class="font-semibold text-lg border-b border-transparent focus:border-emerald-500 w-full bg-transparent p-1 -m-1 transition" 
                                   placeholder="Department Name">
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="app.addClass('${dept.id}')" class="py-1 px-3 bg-blue-500 text-white text-xs font-medium rounded-full hover:bg-blue-600 transition active:scale-95">
                                <i class="ph-fill ph-plus text-sm"></i> Class
                            </button>
                            <button onclick="app.removeDepartment('${dept.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                                <i class="ph-fill ph-x text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 space-y-3" id="classes-list-${dept.id}">
                        <!-- Classes will be rendered here -->
                    </div>
                `;
                list.appendChild(deptDiv);
                
                // Render Classes
                const classesList = document.getElementById(`classes-list-${dept.id}`);
                if (!dept.classes || dept.classes.length === 0) {
                    classesList.innerHTML = `<p class="text-center text-sm text-gray-400">No classes in this department.</p>`;
                } else {
                    dept.classes.forEach((cls, clsIndex) => {
                        const classDiv = document.createElement('div');
                        classDiv.className = 'flex items-center space-x-2 p-2 border border-gray-100 rounded-lg bg-white shadow-xs';
                        classDiv.id = `class-config-${dept.id}-${cls.id}`;
                        classDiv.innerHTML = `
                            <div class="w-3/5">
                                <input type="text" value="${cls.name}" oninput="app.updateClassName('${dept.id}', '${cls.id}', this.value)"
                                       class="text-sm font-medium border-b border-transparent focus:border-blue-500 w-full p-1 -m-1 transition"
                                       placeholder="Class Name (e.g., 1A)">
                            </div>
                            <div class="w-2/5">
                                <select onchange="app.updateClassType('${dept.id}', '${cls.id}', this.value)"
                                        class="text-xs border-gray-300 rounded-md shadow-sm w-full py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Girls" ${cls.type === 'Girls' ? 'selected' : ''}>Girls Section</option>
                                    <option value="Boys" ${cls.type === 'Boys' ? 'selected' : ''}>Boys Section</option>
                                    <option value="Co-ed" ${cls.type === 'Co-ed' ? 'selected' : ''}>Co-ed</option>
                                </select>
                            </div>
                            <button onclick="app.removeClass('${dept.id}', '${cls.id}')" 
                                    class="text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 transition shrink-0">
                                <i class="ph-fill ph-minus-circle text-lg"></i>
                            </button>
                        `;
                        classesList.appendChild(classDiv);
                    });
                }
            });
        }


        // --- REPORT INPUT LOGIC ---

        function openReportModal(classId, className, classType) {
            // Get today's report data
            const report = dailyReports[classId] || {};
            const isReported = !!dailyReports[classId];

            document.getElementById('report-modal-class-id').value = classId;
            document.getElementById('report-modal-class-name').textContent = `${className} (${classType})`;
            document.getElementById('report-modal-date').textContent = selectedDate;

            document.getElementById('report-total').value = report.total ?? '';
            document.getElementById('report-present').value = report.present ?? '';
            document.getElementById('report-pr-brought').value = report.prBrought ?? '';
            document.getElementById('report-pr-signed').value = report.prSigned ?? '';
            document.getElementById('report-dcs-display').textContent = report.dcs !== undefined ? `${report.dcs}%` : '--%';
            
            // Show/Hide delete button
            const deleteBtn = document.getElementById('delete-report-button');
            if (isReported) {
                deleteBtn.classList.remove('hidden');
                document.getElementById('save-report-button').textContent = 'Update Report';
            } else {
                deleteBtn.classList.add('hidden');
                document.getElementById('save-report-button').textContent = 'Save Report';
            }

            appInterface.openModal('report-modal');
        }

        function recalculateDCS() {
            const total = parseInt(document.getElementById('report-total').value) || 0;
            const present = parseInt(document.getElementById('report-present').value) || 0;
            const prBrought = parseInt(document.getElementById('report-pr-brought').value) || 0;
            const prSigned = parseInt(document.getElementById('report-pr-signed').value) || 0;

            const dcs = calculateDCS(total, present, prBrought, prSigned);
            document.getElementById('report-dcs-display').textContent = `${dcs}%`;
            
            // Basic validation
            if (present > total || prBrought > total || prSigned > total) {
                document.getElementById('report-dcs-display').textContent = 'ERR';
                document.getElementById('report-dcs-display').classList.add('text-red-600');
                document.getElementById('save-report-button').disabled = true;
            } else {
                document.getElementById('report-dcs-display').classList.remove('text-red-600');
                document.getElementById('save-report-button').disabled = total === 0;
            }
        }
        
        async function updateReportEntry() {
            const classId = document.getElementById('report-modal-class-id').value;
            const total = parseInt(document.getElementById('report-total').value) || 0;
            const present = parseInt(document.getElementById('report-present').value) || 0;
            const prBrought = parseInt(document.getElementById('report-pr-brought').value) || 0;
            const prSigned = parseInt(document.getElementById('report-pr-signed').value) || 0;
            const dcs = calculateDCS(total, present, prBrought, prSigned);

            if (present > total || prBrought > total || prSigned > total || total === 0) {
                await customConfirm('Validation Error', 'Total strength must be greater than zero, and all attendance/report counts must be less than or equal to the total strength.', false);
                return;
            }

            const newReport = { total, present, prBrought, prSigned, dcs };
            const oldReport = dailyReports[classId] || null;

            const dailyDocRef = doc(db, REPORTS_COLLECTION_PATH, selectedDate);
            const accumDocRef = doc(db, ACCUMULATED_SCORES_COLLECTION_PATH, classId);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Update Daily Report Document
                    transaction.set(dailyDocRef, { [classId]: newReport }, { merge: true });

                    // 2. Update Accumulated Scores Document
                    const accumDoc = await transaction.get(accumDocRef);
                    let { totalScore = 0, daysCount = 0 } = accumDoc.exists() ? accumDoc.data() : {};

                    // Deduct old score if it existed for this day
                    if (oldReport) {
                        totalScore -= oldReport.dcs;
                        // daysCount only decreases if the old report was the ONLY report for that day
                        // This complex logic is handled by setting merge:true on the dailyDocRef
                        // To keep it simple and safe for now: we always count reports as updates, not new entries.
                        // We will adjust only the totalScore for updates, and update daysCount only on first save/delete.
                        // However, since we track oldReport, we can assume daysCount is stable for updates.
                        // A new entry is when oldReport is null AND daysCount is incremented.
                    } else {
                        daysCount += 1; // Only increment daysCount for the first entry of this class on this date
                    }

                    // Add new score
                    totalScore += dcs;

                    // Calculate new average
                    const averageScore = daysCount > 0 ? (totalScore / daysCount) : 0;

                    transaction.set(accumDocRef, { 
                        totalScore: totalScore, 
                        daysCount: daysCount, 
                        averageScore: averageScore 
                    });
                });
                
                appInterface.closeModal('report-modal');
                console.log("Report and Accumulated Score updated successfully in a transaction.");
            } catch (error) {
                console.error("Transaction failed: ", error);
                await customConfirm('Save Failed', 'There was an error saving the report and updating the cumulative score. Please try again.', false);
            }
        }
        
        async function deleteReportEntry() {
            const classId = document.getElementById('report-modal-class-id').value;
            const oldReport = dailyReports[classId];

            if (!oldReport) {
                appInterface.closeModal('report-modal');
                return;
            }
            
            const confirmed = await customConfirm(
                'Confirm Deletion', 
                'Are you sure you want to delete this daily report entry? This will also update the class\'s cumulative performance score.', 
                true
            );
            
            if (!confirmed) return;


            const dailyDocRef = doc(db, REPORTS_COLLECTION_PATH, selectedDate);
            const accumDocRef = doc(db, ACCUMULATED_SCORES_COLLECTION_PATH, classId);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Update Daily Report Document (remove the field)
                    // Firestore doesn't support deleting nested fields using transaction.update() cleanly without a special sentinel, 
                    // which is complex for a map field like this. A simple and safe alternative: read, update, and rewrite the whole daily report document.
                    
                    const dailyDoc = await transaction.get(dailyDocRef);
                    if (dailyDoc.exists()) {
                        const dailyData = dailyDoc.data();
                        delete dailyData[classId]; // Remove the entry
                        transaction.set(dailyDocRef, dailyData); // Rewrite the document
                    }

                    // 2. Update Accumulated Scores Document
                    const accumDoc = await transaction.get(accumDocRef);
                    let { totalScore = 0, daysCount = 0 } = accumDoc.exists() ? accumDoc.data() : {};

                    // Deduct old score and decrease daysCount
                    if (daysCount > 0) {
                        totalScore = Math.max(0, totalScore - oldReport.dcs);
                        daysCount = Math.max(0, daysCount - 1);
                    }
                    
                    // Calculate new average
                    const averageScore = daysCount > 0 ? (totalScore / daysCount) : 0;

                    transaction.set(accumDocRef, { 
                        totalScore: totalScore, 
                        daysCount: daysCount, 
                        averageScore: averageScore 
                    });
                });

                appInterface.closeModal('report-modal');
                console.log("Report deleted and Accumulated Score updated successfully.");
            } catch (error) {
                console.error("Deletion transaction failed: ", error);
                await customConfirm('Deletion Failed', 'There was an error deleting the report and updating the cumulative score. Please try again.', false);
            }
        }
        
        
        // --- CONFIGURATION LOGIC ---

        function updateConfigState(updater) {
            // Helper to ensure config is treated as immutable for state updates
            config = JSON.parse(JSON.stringify(config)); // Deep clone
            updater();
            // Re-render relevant UI after state change (e.g., settings modal)
            renderDepartmentsInSettings();
        }

        function addDepartment() {
            updateConfigState(() => {
                const newId = `dept-${Date.now()}`;
                config.departments.push({ id: newId, name: 'New Department', classes: [] });
            });
        }

        async function removeDepartment(deptId) {
            const confirmed = await customConfirm(
                'Confirm Department Deletion', 
                'Deleting a department will remove all associated classes and their configurations. This action cannot be easily undone.', 
                true
            );
            
            if (confirmed) {
                updateConfigState(() => {
                    config.departments = config.departments.filter(d => d.id !== deptId);
                });
            }
        }

        function updateDepartmentName(deptId, newName) {
            updateConfigState(() => {
                const dept = config.departments.find(d => d.id === deptId);
                if (dept) dept.name = newName;
            });
        }

        function addClass(deptId) {
            updateConfigState(() => {
                const dept = config.departments.find(d => d.id === deptId);
                if (dept) {
                    const newClassId = `cls-${Date.now()}`;
                    dept.classes.push({ id: newClassId, name: 'New Class', type: 'Girls' });
                }
            });
        }

        async function removeClass(deptId, clsId) {
            const confirmed = await customConfirm(
                'Confirm Class Deletion', 
                'This will remove the class. Any existing daily reports or accumulated scores for this class will remain in the database but will no longer be visible in the tracker.', 
                true
            );
            
            if (confirmed) {
                updateConfigState(() => {
                    const dept = config.departments.find(d => d.id === deptId);
                    if (dept) {
                        dept.classes = dept.classes.filter(c => c.id !== clsId);
                    }
                });
            }
        }

        function updateClassName(deptId, clsId, newName) {
            updateConfigState(() => {
                const dept = config.departments.find(d => d.id === deptId);
                const cls = dept?.classes.find(c => c.id === clsId);
                if (cls) cls.name = newName;
            });
        }

        function updateClassType(deptId, clsId, newType) {
            updateConfigState(() => {
                const dept = config.departments.find(d => d.id === deptId);
                const cls = dept?.classes.find(c => c.id === clsId);
                if (cls) cls.type = newType;
            });
        }
        
        async function saveConfig() {
            if (auth.currentUser?.isAnonymous) {
                document.getElementById('save-status').classList.remove('hidden');
                return;
            }

            const name = document.getElementById('config-schoolName').value.trim();
            const address = document.getElementById('config-schoolAddress').value.trim();
            const phone = document.getElementById('config-schoolPhone').value.trim();
            const website = document.getElementById('config-schoolWebsite').value.trim();
            const logoText = document.getElementById('config-schoolLogoText').value.trim();
            const logoFile = document.getElementById('config-schoolLogoFile').files[0];

            let logoUrl = config.schoolInfo.logoUrl || '';
            let newLogoUploaded = false;
            
            // 1. Handle Logo Image Upload
            if (logoFile) {
                document.getElementById('logo-status').textContent = 'Uploading...';
                try {
                    const logoRef = storageRef(storage, STORAGE_LOGO_PATH);
                    const snapshot = await uploadBytes(logoRef, logoFile);
                    logoUrl = await getDownloadURL(snapshot.ref);
                    document.getElementById('logo-status').textContent = 'Upload complete.';
                    newLogoUploaded = true;
                } catch (error) {
                    console.error("Logo upload failed:", error);
                    document.getElementById('logo-status').textContent = 'Upload failed.';
                    // Don't save URL if upload failed, keep old one or clear it.
                    logoUrl = config.schoolInfo.logoUrl || ''; 
                }
            } else if (config.schoolInfo.logoUrl && !logoFile && !logoUrl) {
                // If user cleared file input AND config had a URL, clear the URL
                try {
                    await deleteObject(storageRef(storage, STORAGE_LOGO_PATH));
                    logoUrl = '';
                    console.log('Old logo deleted from storage.');
                } catch (error) {
                    // Ignore error if file simply didn't exist
                    logoUrl = '';
                }
            } else if (config.schoolInfo.logoUrl && !logoFile) {
                // Keep existing URL if file input is empty and we are not explicitly clearing it.
                logoUrl = config.schoolInfo.logoUrl;
            } else {
                logoUrl = '';
            }

            // 2. Prepare new config object
            const newConfig = {
                ...config,
                schoolInfo: {
                    name, address, phone, website, logoText, logoUrl
                },
                // Re-slug class IDs to ensure they are consistent before saving
                departments: config.departments.map(dept => ({
                    ...dept,
                    classes: dept.classes.map(cls => ({
                        ...cls,
                        id: slugify(`${cls.name}-${cls.type}`) // Ensure slug is saved as ID
                    }))
                }))
            };

            // 3. Save to Firestore
            try {
                await setDoc(doc(db, CONFIG_DOC_PATH), { config: newConfig });
                
                // Update local config immediately after save
                config = newConfig; 
                if (newLogoUploaded) appInterface.updateLogoPreview(); // Refresh preview if logo changed
                
                document.getElementById('logo-status').textContent = 'Configuration saved successfully!';
                document.getElementById('save-config-button').textContent = 'Saved!';
                setTimeout(() => {
                    document.getElementById('save-config-button').textContent = 'Save Configuration';
                    document.getElementById('logo-status').textContent = '';
                }, 2000);
            } catch (error) {
                console.error("Error saving configuration:", error);
                document.getElementById('logo-status').textContent = 'Error: Save failed. See console.';
            }
        }

        
        // --- APP INTERFACE (Public Methods) ---
        
        const appInterface = {
            
            // --- MODAL & UI CONTROL ---
            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    // Add listener to close on outside click (for large modals)
                    modal.onclick = (e) => {
                        if (e.target.id === modalId) {
                            appInterface.closeModal(modalId);
                        }
                    };
                }
            },
            
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    modal.onclick = null; // Remove outside click listener
                }
            },
            
            toggleAuthMenu: (event) => {
                event.stopPropagation(); // Prevent document click from closing immediately
                const menu = document.getElementById('auth-menu');
                menu.classList.toggle('hidden');
                
                // Add a temporary click listener to close the menu when clicking anywhere else
                const closeMenu = (e) => {
                    if (!document.getElementById('auth-button').contains(e.target)) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenu);
                    }
                };
                if (!menu.classList.contains('hidden')) {
                    document.addEventListener('click', closeMenu);
                } else {
                    document.removeEventListener('click', closeMenu);
                }
            },
            
            copyUserId: () => {
                if (userId) {
                    navigator.clipboard.writeText(userId)
                        .then(() => {
                            const display = document.getElementById('user-id-display');
                            const originalText = display.textContent;
                            display.textContent = 'Copied!';
                            setTimeout(() => display.textContent = originalText, 1500);
                        })
                        .catch(err => {
                            console.error('Failed to copy text: ', err);
                            // Fallback for environment restrictions
                            const dummy = document.createElement("textarea");
                            document.body.appendChild(dummy);
                            dummy.value = userId;
                            dummy.select();
                            document.execCommand("copy");
                            document.body.removeChild(dummy);
                        });
                }
            },
            
            setDate: (dateString) => {
                selectedDate = dateString;
                document.getElementById('selected-date-display').textContent = dateString;
                // Since selectedDate is changed, the onSnapshot listener for daily reports needs to be re-established.
                // Re-running initializeFirebase or just setupDataListeners is overkill. 
                // The existing listener for the old date will die when the tab is closed/page reloaded in a real app,
                // but here, we need to explicitly listen for the new document. 
                // A simpler approach for this environment: re-initialise the listener logic.
                if (db) {
                     // 3. Daily Reports Listener (for the selected date) - Re-subscribe
                    onSnapshot(doc(db, REPORTS_COLLECTION_PATH, selectedDate), (docSnap) => {
                        dailyReports = docSnap.exists() ? docSnap.data() : {};
                        console.log(`Daily reports for ${selectedDate} updated (re-subscribed).`);
                        renderDashboard();
                    }, (error) => {
                        console.error(`Error listening to daily reports for ${selectedDate}:`, error);
                    });
                }
                
            },
            
            showSettingsTab: (tabId) => {
                document.getElementById('school-info-tab').classList.add('hidden');
                document.getElementById('departments-tab').classList.add('hidden');
                
                document.getElementById('tab-school-info').classList.remove('active', 'border-emerald-600');
                document.getElementById('tab-departments').classList.remove('active', 'border-emerald-600');

                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                document.getElementById(`tab-${tabId}`).classList.add('active', 'border-emerald-600');
            },
            
            updateLogoPreview: () => {
                const info = config.schoolInfo || {};
                const fileInput = document.getElementById('config-schoolLogoFile');
                const previewImg = document.getElementById('school-logo-img');
                const previewText = document.getElementById('school-logo-text');

                // Read file selected by user
                if (fileInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        previewImg.classList.remove('hidden');
                        previewText.classList.add('hidden');
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else if (info.logoUrl) {
                    // Revert to existing saved URL if file cleared
                    previewImg.src = info.logoUrl;
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                } else {
                    // Revert to text if file cleared and no existing URL
                    previewImg.classList.add('hidden');
                    previewText.classList.remove('hidden');
                    previewText.textContent = document.getElementById('config-schoolLogoText').value.trim() || 'T.';
                }
            },

            openSettingsModal: function() {
                // Initialize input fields with current config
                const info = config.schoolInfo || {};
                document.getElementById('config-schoolName').value = info.name || '';
                document.getElementById('config-schoolAddress').value = info.address || '';
                document.getElementById('config-schoolPhone').value = info.phone || '';
                document.getElementById('config-schoolWebsite').value = info.website || '';
                document.getElementById('config-schoolLogoText').value = info.logoText || 'T.';
                
                // Reset file input and status
                document.getElementById('config-schoolLogoFile').value = '';
                document.getElementById('logo-status').textContent = '';
                
                // Show logo preview based on current saved state
                const previewImg = document.getElementById('school-logo-img');
                const previewText = document.getElementById('school-logo-text');
                
                if (info.logoUrl) {
                    previewImg.src = info.logoUrl;
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                } else {
                    previewImg.classList.add('hidden');
                    previewText.classList.remove('hidden');
                    previewText.textContent = info.logoText || 'T.';
                }
                
                // Add change listener to file input for live preview
                document.getElementById('config-schoolLogoFile').onchange = () => {
                    appInterface.updateLogoPreview();
                };
                
                // Add change listener to text input for live preview
                document.getElementById('config-schoolLogoText').oninput = () => {
                    if (!document.getElementById('config-schoolLogoFile').files[0] && !info.logoUrl) {
                        // Revert to text if file cleared and no existing URL
                        previewImg.classList.add('hidden');
                        previewText.classList.remove('hidden');
                        previewText.textContent = document.getElementById('config-schoolLogoText').value.trim() || 'T.';
                    }
                };

                renderDepartmentsInSettings();
                this.openModal('settings-modal', 'settings-content-wrapper');
            },

            signInWithGoogle: signInWithGoogle,
            signOutUser: signOutUser,
            addDepartment: addDepartment,
            removeDepartment: removeDepartment,
            updateDepartmentName: updateDepartmentName,
            addClass: addClass,
            removeClass: removeClass,
            updateClassName: updateClassName,
            updateClassType: updateClassType,
            saveConfig: saveConfig,
            openReportModal: openReportModal,
            recalculateDCS: recalculateDCS,
            updateReportEntry: updateReportEntry,
            deleteReportEntry: deleteReportEntry,
        };

        window.app = appInterface; 

        // --- INITIAL SETUP ---
        
        // Use document.addEventListener('DOMContentLoaded', ...) instead of window.onload
        // to ensure it runs as soon as the DOM is ready.
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

    </script>
</body>
</html>
