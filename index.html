<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Firebase App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen p-4 md:p-10 flex flex-col items-center">
        <header class="w-full max-w-4xl mb-8">
            <h1 class="text-4xl font-bold text-center text-indigo-700">Firestore & Google Auth Demo</h1>
        </header>

        <!-- Message Box -->
        <div id="message-box" class="w-full max-w-xl p-3 mb-4 rounded-lg text-center text-sm hidden"></div>

        <!-- Authentication and Status Section -->
        <div id="auth-status" class="w-full max-w-xl bg-white p-6 shadow-lg rounded-xl mb-8 border border-gray-100">
            <div id="loading-indicator" class="text-center text-gray-500">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Initializing Firebase...
            </div>
            
            <div id="logged-out-view" class="hidden text-center">
                <p class="text-gray-600 mb-4">Please sign in to access your private notes.</p>
                <button onclick="signInWithGoogle()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-1" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M22.001 12.185c0-.986-.098-1.92-.262-2.812H12.03v5.334h5.686c-.244 1.25-.89 2.457-1.84 3.486l-.001.002-4.008 3.097v.002h.003c2.723 0 5.25-1.07 7.147-3.003C21.436 16.594 22 14.484 22 12.185z" fill="#4285F4"/><path d="M12.03 22c3.23 0 5.92-1.066 7.892-2.887l-4.006-3.097c-1.12.722-2.557 1.148-3.886 1.148-2.986 0-5.51-2.007-6.425-4.706H1.54v.033C3.41 19.336 7.37 22 12.03 22z" fill="#34A853"/><path d="M5.605 13.911c-.24-.722-.375-1.488-.375-2.261 0-.773.135-1.538.375-2.26l-.002-.016H1.539v2.293c.725 3.09 3.553 5.418 6.577 5.418.995 0 1.94-.216 2.784-.582l-2.046-1.58C6.918 15.65 6.136 14.88 5.605 13.911z" fill="#FBBC05"/><path d="M12.03 6.94c1.652 0 3.085.674 4.234 1.764L19.53 5.093c-2.015-1.91-4.7-3.093-7.498-3.093C7.37 2 3.41 4.67 1.54 8.083h4.065c.915-2.698 3.439-4.706 6.425-4.706z" fill="#EA4335"/></svg>
                    Sign in with Google
                </button>
            </div>

            <div id="logged-in-view" class="hidden">
                <div class="flex flex-col md:flex-row items-center justify-between mb-4">
                    <p class="text-sm text-gray-500 mb-2 md:mb-0">Logged in as: <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded-md break-all"></span></p>
                    <button onclick="signOutUser()" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Sign Out
                    </button>
                </div>
                <hr class="mb-4">
                
                <!-- Notes Input Form -->
                <form id="note-form" class="space-y-4">
                    <textarea id="note-text" rows="3" placeholder="Write a new private note here..." 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        Save Note
                    </button>
                </form>
            </div>
        </div>

        <!-- Notes Display Section -->
        <div id="notes-container" class="w-full max-w-xl hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Your Private Notes</h2>
            <div id="notes-list" class="space-y-3">
                <p id="no-notes" class="text-gray-500 text-center py-4 border border-dashed border-gray-300 rounded-lg">No notes found. Add one above!</p>
                <!-- Notes will be inserted here -->
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let unsubscribeNotes = () => {}; // Placeholder for the unsubscribe function

        const loadingIndicator = document.getElementById('loading-indicator');
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');
        const notesContainer = document.getElementById('notes-container');
        const notesList = document.getElementById('notes-list');
        const noteForm = document.getElementById('note-form');
        const noteText = document.getElementById('note-text');
        const userIdDisplay = document.getElementById('user-id-display');
        const messageBox = document.getElementById('message-box');
        // FIX: Cache the reference to the "no notes found" message element
        const noNotesMessage = document.getElementById('no-notes');

        // --- Utility Functions ---

        /**
         * Displays a message in the message box.
         * @param {string} msg - The message to display.
         * @param {('success'|'error'|'info')} type - The type of message.
         */
        function showMessage(msg, type = 'info') {
            let bgColor = 'bg-blue-100 border-blue-400 text-blue-700';
            if (type === 'error') bgColor = 'bg-red-100 border-red-400 text-red-700';
            if (type === 'success') bgColor = 'bg-green-100 border-green-400 text-green-700';

            messageBox.textContent = msg;
            messageBox.className = `w-full max-w-xl p-3 mb-4 rounded-lg text-center text-sm border ${bgColor}`;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        /**
         * Gets the Firestore collection reference for the user's private notes.
         * @returns {import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").CollectionReference}
         */
        function getNoteCollectionRef() {
            if (!db || !userId) {
                console.error("Database or User ID is not ready.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/simple_notes
            return collection(db, `artifacts/${appId}/users/${userId}/simple_notes`);
        }

        // --- Authentication Functions ---

        /** Signs in with Google using a popup. */
        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Successfully signed in with Google!", 'success');
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showMessage(`Google Sign-In failed: ${error.message}`, 'error');
            }
        }

        /** Signs out the current user. */
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showMessage("Successfully signed out.", 'info');
            } catch (error) {
                console.error("Sign-out Error:", error);
                showMessage(`Sign-out failed: ${error.message}`, 'error');
            }
        }

        /**
         * Main function to initialize Firebase and handle initial authentication.
         */
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                loadingIndicator.textContent = "Error: Firebase configuration is missing.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // Optional: set log level for debugging
                // setLogLevel('debug'); 

                loadingIndicator.style.display = 'block';
                
                // 1. Initial Authentication using Canvas token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up the state listener
                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.style.display = 'none';

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        loggedOutView.classList.add('hidden');
                        loggedInView.classList.remove('hidden');
                        notesContainer.classList.remove('hidden');
                        
                        // Start listening to notes for the current user
                        setupRealtimeListener();

                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'N/A';
                        loggedOutView.classList.remove('hidden');
                        loggedInView.classList.add('hidden');
                        notesContainer.classList.add('hidden');

                        // Stop listening when user logs out
                        unsubscribeNotes();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingIndicator.textContent = `Initialization Error: ${error.message}`;
            }
        }
        
        // --- Firestore Functions ---

        /** Adds a new note to the user's collection. */
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = noteText.value.trim();

            if (!text) {
                showMessage("Note cannot be empty.", 'info');
                return;
            }

            if (!userId) {
                showMessage("Please sign in to save notes.", 'error');
                return;
            }

            const notesColRef = getNoteCollectionRef();
            if (!notesColRef) return;

            try {
                await addDoc(notesColRef, {
                    text: text,
                    createdAt: serverTimestamp(),
                    userId: userId 
                });
                noteText.value = '';
                showMessage("Note saved successfully!", 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage(`Failed to save note: ${error.message}`, 'error');
            }
        });

        /**
         * Sets up the real-time listener for the user's notes.
         */
        function setupRealtimeListener() {
            // Stop any existing listener
            unsubscribeNotes(); 
            notesList.innerHTML = '';
            // FIX: Use the cached constant reference instead of document.getElementById
            noNotesMessage.classList.add('hidden');

            const notesColRef = getNoteCollectionRef();
            if (!notesColRef) return;

            // Define the query: get all notes for the current user
            // NOTE: We avoid using orderBy('createdAt') in the query to prevent index issues. 
            // We will fetch all data and sort it in memory.
            const q = query(notesColRef); 

            // Start listening for real-time updates
            unsubscribeNotes = onSnapshot(q, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => {
                    // Collect notes with their ID and data
                    notes.push({ id: doc.id, ...doc.data() });
                });

                // Sort notes in memory by createdAt (descending)
                notes.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderNotes(notes);

            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                showMessage(`Error fetching notes: ${error.message}`, 'error');
                renderNotes([]); // Clear the list on error
            });
        }
        
        /**
         * Renders the list of notes to the UI.
         * @param {Array<Object>} notes - The array of note objects.
         */
        function renderNotes(notes) {
            notesList.innerHTML = ''; // Clear existing notes

            if (notes.length === 0) {
                // FIX: Use the cached constant reference
                noNotesMessage.classList.remove('hidden');
                return;
            }
            // FIX: Use the cached constant reference
            noNotesMessage.classList.add('hidden');


            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'bg-white p-4 shadow-sm rounded-lg border border-gray-100 hover:shadow-md transition duration-150';
                
                // Format the timestamp
                let dateStr = 'Pending...';
                if (note.createdAt && note.createdAt.toDate) {
                    dateStr = note.createdAt.toDate().toLocaleString();
                }

                noteElement.innerHTML = `
                    <p class="text-gray-800 whitespace-pre-wrap">${note.text}</p>
                    <div class="mt-2 flex justify-between items-center text-xs text-gray-400">
                        <span>Saved: ${dateStr}</span>
                    </div>
                `;
                notesList.appendChild(noteElement);
            });
        }

        // --- Start the Application ---
        window.addEventListener('load', initializeAppAndAuth);

    </script>
</body>
</html>
