<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Compact Class Performance Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons (for the UI) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Enforce full viewport height and prevent main page scrolling */
        html, body { 
            height: 100%;
            min-height: 100vh;
            overflow: hidden; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9; 
            display: flex;
            flex-direction: column;
        }

        /* Utility classes for tiny text used in the Class Cards */
        .text-4xs {
            font-size: 0.5rem; /* ~8px */
        }
        .text-3xs {
            font-size: 0.55rem; /* ~8.8px */
        }
        .text-2xs {
            font-size: 0.65rem; /* ~10.4px */
        }

        /* Custom progress bar styling for class cards */
        .progress-bar-bg {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        /* Custom scrollbar for better modal aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Utility for different performance levels */
        .level-excellent { border-left-color: #10b981; } /* Emerald 500 */
        .level-good { border-left-color: #3b82f6; } /* Blue 500 */
        .level-fair { border-left-color: #f59e0b; } /* Amber 500 */
        .level-poor { border-left-color: #ef4444; } /* Red 500 */

        .level-excellent-bg { background-color: #10b981; }
        .level-good-bg { background-color: #3b82f6; }
        .level-fair-bg { background-color: #f59e0b; }
        .level-poor-bg { background-color: #ef4444; }
        
        /* Button focus styles */
        button:focus, a:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-color: transparent !important;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Global Message/Notification Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-all duration-300 opacity-0 transform translate-x-full">
        <div class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl flex items-center space-x-2">
            <i class="ph-info-fill text-lg"></i>
            <span id="message-text" class="text-sm"></span>
        </div>
    </div>

    <!-- Main Application Header -->
    <header class="bg-white shadow-md p-4 flex items-center justify-between z-10 sticky top-0">
        <div class="flex items-center space-x-3">
            <!-- School Logo/Text -->
            <div id="school-logo-container" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-200 text-lg font-bold text-gray-700 overflow-hidden shrink-0">
                <img id="school-logo-img" class="object-cover w-full h-full hidden" alt="School Logo">
                <span id="school-logo-text">T.</span>
            </div>
            
            <div class="text-sm">
                <h1 id="school-name-display" class="font-bold text-gray-800 truncate max-w-40 sm:max-w-64">Ultra Tracker</h1>
                <p id="school-contact-display" class="text-xs text-gray-500 hidden sm:block truncate max-w-64">No contact info set</p>
            </div>
        </div>

        <!-- Middle Controls (Date Picker) -->
        <div class="flex items-center space-x-2 sm:space-x-4">
            <input type="date" id="date-picker" class="p-2 border border-gray-300 rounded-lg text-sm bg-white hover:border-blue-500 transition focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Right Controls (Settings and Auth) -->
        <div class="flex items-center space-x-3">
            <button id="settings-button" onclick="window.app.openSettings()" class="p-2 rounded-full hover:bg-gray-100 transition text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Settings">
                <i class="ph-gear-fill text-xl"></i>
            </button>
            <button id="auth-button" onclick="window.app.signInWithGoogle()" class="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition focus:outline-none focus:ring-2 focus:ring-blue-500" title="Sign In">
                <i class="ph-user-circle-fill text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
        <div id="loading-spinner" class="text-center p-8">
            <i class="ph-circle-notch-fill animate-spin text-4xl text-blue-500"></i>
            <p class="text-gray-600 mt-2">Loading data and configuring Firebase...</p>
        </div>

        <div id="tracker-dashboard" class="max-w-7xl mx-auto hidden">
            <!-- Department and Class Structure will be rendered here -->
            <div id="departments-container">
                <!-- Example Structure for a Department -->
                <!--
                <section class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-700 mb-3 border-b pb-1">Weekend School</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ... Girls and Boys Sections ...
                    </div>
                </section>
                -->
            </div>

            <!-- Empty State -->
            <div id="empty-config-message" class="hidden text-center p-12 bg-white rounded-xl shadow-lg mt-8">
                <i class="ph-chalkboard-teacher-fill text-6xl text-gray-400"></i>
                <h3 class="text-xl font-semibold text-gray-700 mt-4">No Classes Configured</h3>
                <p class="text-gray-500 mt-2">Use the <span class="font-semibold text-blue-600">Settings</span> button (gear icon) to add your departments and classes.</p>
                <button onclick="window.app.openSettings()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition">
                    Open Settings
                </button>
            </div>
        </div>
    </main>

    <!-- --- MODALS --- -->

    <!-- 1. Report Input Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.id === 'report-modal') window.app.closeModal('report-modal')">
        <div id="report-content-wrapper" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Daily Report for <span id="report-class-name">Class X</span></h3>
            <p id="report-date-display" class="text-sm text-gray-500 mb-6"></p>

            <form id="report-form" onsubmit="event.preventDefault(); window.app.updateReportEntry()">
                <div class="space-y-4">
                    <!-- Total Students -->
                    <div class="flex items-center justify-between">
                        <label for="report-total" class="text-gray-700 font-medium">Total Students</label>
                        <input type="number" id="report-total" min="0" required class="w-24 p-2 border border-gray-300 rounded-lg text-right" oninput="window.app.recalculateDCS()" placeholder="0">
                    </div>
                    <!-- Present Today -->
                    <div class="flex items-center justify-between">
                        <label for="report-present" class="text-gray-700 font-medium">Present Today (50% weight)</label>
                        <input type="number" id="report-present" min="0" required class="w-24 p-2 border border-gray-300 rounded-lg text-right" oninput="window.app.recalculateDCS()" placeholder="0">
                    </div>
                    <!-- Progress Report Brought -->
                    <div class="flex items-center justify-between">
                        <label for="report-pr-brought" class="text-gray-700 font-medium">PR Brought (25% weight)</label>
                        <input type="number" id="report-pr-brought" min="0" required class="w-24 p-2 border border-gray-300 rounded-lg text-right" oninput="window.app.recalculateDCS()" placeholder="0">
                    </div>
                    <!-- Progress Report Signed -->
                    <div class="flex items-center justify-between">
                        <label for="report-pr-signed" class="text-gray-700 font-medium">PR Signed (25% weight)</label>
                        <input type="number" id="report-pr-signed" min="0" required class="w-24 p-2 border border-gray-300 rounded-lg text-right" oninput="window.app.recalculateDCS()" placeholder="0">
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                    <div class="text-left">
                        <p class="text-sm text-gray-500">Daily Class Score (DCS)</p>
                        <p id="report-dcs-display" class="text-3xl font-extrabold text-blue-600">0.0%</p>
                    </div>
                    <div class="space-x-3">
                        <button type="button" onclick="window.app.closeModal('report-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="submit" id="report-submit-button" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition disabled:bg-gray-400" disabled>
                            <span id="report-submit-text">Save Report</span>
                            <i id="report-submit-spinner" class="ph-circle-notch-fill animate-spin hidden ml-1"></i>
                        </button>
                        <button type="button" id="report-delete-button" onclick="window.app.deleteReportEntry()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition hidden">Delete</button>
                    </div>
                </div>
                <p id="report-error-message" class="text-red-500 text-sm mt-3 hidden"></p>
            </form>
        </div>
    </div>

    <!-- 2. Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.id === 'settings-modal') window.app.closeModal('settings-modal')">
        <div id="settings-content-wrapper" class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] transform transition-all duration-300 scale-95 opacity-0 flex flex-col p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Application Settings</h3>
            
            <div class="flex-grow overflow-y-auto custom-scrollbar space-y-8 pr-4">
                
                <!-- School Information Section -->
                <section>
                    <h4 class="text-xl font-semibold text-gray-700 mb-3 flex items-center space-x-2"><i class="ph-buildings text-2xl"></i><span>School Information</span></h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="config-schoolName" class="block text-sm font-medium text-gray-700">School Name (Required)</label>
                            <input type="text" id="config-schoolName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="col-span-1">
                            <label for="config-schoolAddress" class="block text-sm font-medium text-gray-700">Address</label>
                            <input type="text" id="config-schoolAddress" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="col-span-1">
                            <label for="config-schoolPhone" class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="tel" id="config-schoolPhone" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="col-span-1">
                            <label for="config-schoolWebsite" class="block text-sm font-medium text-gray-700">Website</label>
                            <input type="url" id="config-schoolWebsite" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="https://example.com">
                        </div>
                        <div class="col-span-full md:col-span-1">
                            <label for="config-schoolLogo" class="block text-sm font-medium text-gray-700">School Logo Image (PNG/JPG)</label>
                            <input type="file" id="config-schoolLogo" accept=".png, .jpg, .jpeg" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div class="col-span-full md:col-span-1">
                            <label for="config-schoolLogoText" class="block text-sm font-medium text-gray-700">Logo Text Fallback (1 char)</label>
                            <input type="text" id="config-schoolLogoText" maxlength="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg uppercase" placeholder="E.g., T">
                        </div>
                    </div>
                </section>
                
                <!-- Departments & Classes Section -->
                <section>
                    <h4 class="text-xl font-semibold text-gray-700 mb-4 flex items-center justify-between">
                        <span class="flex items-center space-x-2"><i class="ph-hard-hat-fill text-2xl"></i><span>Departments & Classes</span></span>
                        <button onclick="window.app.addDepartment()" type="button" class="flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition shadow">
                            <i class="ph-plus text-lg"></i><span>Add Department</span>
                        </button>
                    </h4>

                    <div id="departments-config-container" class="space-y-6">
                        <!-- Departments will be rendered here -->
                    </div>
                </section>

            </div>

            <!-- Footer for Save Button -->
            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                <div class="space-x-3">
                    <button type="button" onclick="window.app.closeModal('settings-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Close</button>
                    <button id="config-save-button" onclick="window.app.saveConfig()" type="button" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow disabled:bg-gray-400">
                        <span id="config-save-text">Save All Settings</span>
                        <i id="config-save-spinner" class="ph-circle-notch-fill animate-spin hidden ml-1"></i>
                    </button>
                </div>
            </div>
            <p id="settings-error-message" class="text-red-500 text-sm mt-3 hidden text-right"></p>
        </div>
    </div>
    
    <!-- 3. Confirmation/Custom Alert Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0" id="confirm-content-wrapper">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirm-title">Confirm Action</h3>
            <p class="text-gray-600 mb-6" id="confirm-message">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="window.app.confirmReject()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button type="button" onclick="window.app.confirmResolve()" id="confirm-action-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Confirm</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Added 'deleteField' to this import list
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, query, where, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP STATE ---
        let db;
        let auth;
        let storage;
        let userId = null;
        let authReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let config = { 
            schoolInfo: { 
                name: "Ultra Tracker", 
                logoUrl: null, 
                logoText: 'T.',
                address: "", phone: "", website: ""
            }, 
            departments: [] 
        };
        let dailyReports = {};
        let accumulatedScores = {};
        let configSnapshotUnsub;
        let reportsSnapshotUnsub;
        let accumulatedSnapshotUnsub;
        
        // Date tracking
        let selectedDate = new Date(); // Defaults to today

        // Confirmation Modal Promise Handlers
        let resolveConfirm;
        let rejectConfirm;


        // --- FIREBASE PATHS & CONSTANTS ---
        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/config/schoolConfig`;
        const ACCUMULATED_COL_PATH = `artifacts/${appId}/public/data/accumulated_class_scores`;
        const STORAGE_LOGO_PATH = `artifacts/${appId}/public/logo/school_logo`;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // Hardcoded fallback configuration provided by the user (as a JSON string)
const userProvidedConfigString = `{
    "apiKey": "AIzaSyCtsveJ8hmw6JJN4YlouNuHhmvSYumiMos",
    "authDomain": "classroom-chronicle-l6lhk.firebaseapp.com",
    "projectId": "classroom-chronicle-l6lhk",
    "storageBucket": "classroom-chronicle-l6lhk.firebasestorage.app",
    "messagingSenderId": "642583297310",
    "appId": "1:642583297310:web:fdb8da9ab0f01cd9aa9d0f"
}`;

// Prioritize the environment variable (__firebase_config) but fall back to the user's config string if not defined.
const firebaseConfigJson = typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : userProvidedConfigString;
const firebaseConfig = JSON.parse(firebaseConfigJson);

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const authPromise = new Promise((resolve) => {
                    // Set up Auth State Listener
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            authReady = true;
                            await setupRealtimeListeners();
                            updateAuthButton('Sign Out / User ID: ' + userId);
                        } else {
                            // If user logs out or initial check fails (and no initial token provided)
                            userId = null;
                            authReady = true;
                            // Attempt anonymous sign-in if no token was available
                            if (!initialAuthToken) {
                                await signInAnonymously(auth);
                            } else {
                                // If initial token was provided but failed, or logged out, set up UI
                                updateAuthButton('Sign In');
                            }
                        }
                        resolve();
                    });
                });

                // Authenticate using the provided token if it exists
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Start the anonymous sign-in process if no token
                    await signInAnonymously(auth);
                }

                await authPromise; // Wait for onAuthStateChanged to complete its initial run

                // Setup date picker
                const datePicker = document.getElementById('date-picker');
                const today = formatToISODate(selectedDate);
                datePicker.value = today;
                datePicker.max = today; // Cannot select future dates
                datePicker.addEventListener('change', (e) => {
                    const newDate = new Date(e.target.value);
                    newDate.setHours(0, 0, 0, 0); // Normalize to start of day
                    selectedDate = newDate;
                    setupRealtimeListeners();
                });

                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('tracker-dashboard').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification(`Initialization failed. Check console for details.`, 'error');
            }
        }

        /**
         * Sets up all Firestore real-time listeners (Config, Reports, Accumulated Scores).
         */
        async function setupRealtimeListeners() {
            // Unsubscribe existing listeners
            if (configSnapshotUnsub) configSnapshotUnsub();
            if (reportsSnapshotUnsub) reportsSnapshotUnsub();
            if (accumulatedSnapshotUnsub) accumulatedSnapshotUnsub();
            
            // 1. Listen for Config changes
            configSnapshotUnsub = onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    config = { ...config, ...docSnap.data() };
                    renderSchoolInfo();
                } else {
                    // Use default config if doc doesn't exist (first run)
                    console.log("School config not found, using defaults.");
                }
                renderDashboard(); // Re-render whenever config changes
            }, (error) => console.error("Error listening to config:", error));

            // 2. Listen for Daily Reports (based on selectedDate)
            const todayISO = formatToISODate(selectedDate);
            const reportDocRef = doc(db, `artifacts/${appId}/public/data/daily_attendance_reports/${todayISO}`);
            
            reportsSnapshotUnsub = onSnapshot(reportDocRef, (docSnap) => {
                dailyReports = docSnap.exists() ? docSnap.data() : {};
                renderDashboard(); // Re-render dashboard to show daily stats
            }, (error) => console.error("Error listening to daily reports:", error));

            // 3. Listen for Accumulated Scores
            accumulatedSnapshotUnsub = onSnapshot(collection(db, ACCUMULATED_COL_PATH), (snapshot) => {
                accumulatedScores = {};
                snapshot.forEach(doc => {
                    accumulatedScores[doc.id] = doc.data();
                });
                renderDashboard(); // Re-render dashboard to show cumulative scores
            }, (error) => console.error("Error listening to accumulated scores:", error));
        }

        /**
         * Updates the header school information.
         */
        function renderSchoolInfo() {
            const info = config.schoolInfo;
            document.getElementById('school-name-display').textContent = info.name || 'Ultra Tracker';
            document.getElementById('school-contact-display').textContent = info.address || info.phone || info.website || 'No contact info set';

            const logoImg = document.getElementById('school-logo-img');
            const logoText = document.getElementById('school-logo-text');

            if (info.logoUrl) {
                logoImg.src = info.logoUrl;
                logoImg.classList.remove('hidden');
                logoText.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                logoText.classList.remove('hidden');
                logoText.textContent = info.logoText || 'T.';
            }
        }

        /**
         * Renders the entire class performance dashboard.
         */
        function renderDashboard() {
            const container = document.getElementById('departments-container');
            container.innerHTML = ''; // Clear previous content

            if (config.departments.length === 0) {
                document.getElementById('empty-config-message').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-config-message').classList.add('hidden');

            const isToday = formatToISODate(selectedDate) === formatToISODate(new Date());

            config.departments.forEach(dept => {
                const deptElement = document.createElement('section');
                deptElement.className = 'mb-8 p-4 bg-white rounded-xl shadow-lg';
                
                let deptContent = `
                    <h2 class="text-xl sm:text-2xl font-extrabold text-gray-800 mb-4 pb-2 border-b border-gray-200">${dept.name}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                `;
                
                // Group classes by type (Girls/Boys)
                const girlsClasses = dept.classes.filter(cls => cls.type === 'Girls');
                const boysClasses = dept.classes.filter(cls => cls.type === 'Boys');

                // Helper to render class section
                const renderClassSection = (title, classes) => {
                    if (classes.length === 0) return '';
                    let sectionHtml = `
                        <div class="space-y-4">
                            <h3 class="text-lg font-bold text-gray-600 border-b border-dashed pb-1">${title} Section</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    `;
                    classes.forEach(cls => {
                        sectionHtml += renderClassCard(cls, isToday);
                    });
                    sectionHtml += `</div></div>`;
                    return sectionHtml;
                };

                deptContent += renderClassSection('Girls', girlsClasses);
                deptContent += renderClassSection('Boys', boysClasses);

                deptContent += `</div>`;
                deptElement.innerHTML = deptContent;
                container.appendChild(deptElement);
            });
        }

        /**
         * Renders a single class card HTML.
         */
        function renderClassCard(cls, isToday) {
            const dailyData = dailyReports[cls.id] || { total: 0, present: 0, prBrought: 0, prSigned: 0, dcs: 0, exists: false };
            const accumulatedData = accumulatedScores[cls.id] || { totalScore: 0, daysCount: 0, averageScore: 0 };

            const dailyDCS = dailyData.dcs || 0;
            const avgScore = accumulatedData.averageScore || 0;

            // Determine cumulative performance level
            let levelClass = 'level-poor'; // Default
            if (avgScore >= 90) levelClass = 'level-excellent';
            else if (avgScore >= 80) levelClass = 'level-good';
            else if (avgScore >= 70) levelClass = 'level-fair';
            
            const buttonClass = isToday ? 'hover:shadow-lg hover:ring-2 hover:ring-blue-500 hover:scale-[1.02] active:scale-[0.98]' : 'cursor-not-allowed opacity-70';
            const actionText = isToday ? (dailyData.exists ? 'Edit' : 'Enter') : 'View';

            return `
                <div class="class-card bg-white p-3 rounded-xl shadow-md border-l-4 ${levelClass} transition duration-150 transform">
                    <button 
                        onclick="window.app.openReportModal('${cls.id}', '${cls.name} - ${cls.type}')" 
                        class="w-full text-left focus:outline-none rounded-lg p-1 -m-1 ${buttonClass}"
                        ${!isToday ? 'disabled' : ''}
                        title="${isToday ? actionText + ' Report' : 'Viewing historical data only'}">
                        
                        <!-- Top Row: Name and Average -->
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-extrabold text-gray-800 truncate max-w-[70%]">${cls.name} (${cls.type.charAt(0)})</span>
                            <span class="text-2xs font-bold text-gray-500 text-right leading-none whitespace-nowrap">
                                <span class="block text-4xs font-normal">Avg.</span>
                                ${avgScore.toFixed(1)}%
                            </span>
                        </div>

                        <!-- Daily Stats (3x font) -->
                        <div class="grid grid-cols-4 gap-1 text-center bg-gray-50 rounded p-1 mb-2">
                            <div title="Total Students"><span class="block text-4xs text-gray-500">T</span><span class="block text-xs font-bold">${dailyData.total}</span></div>
                            <div title="Present Today (50%)"><span class="block text-4xs text-gray-500">P</span><span class="block text-xs font-bold">${dailyData.present}</span></div>
                            <div title="PR Brought (25%)"><span class="block text-4xs text-gray-500">PR</span><span class="block text-xs font-bold">${dailyData.prBrought}</span></div>
                            <div title="PR Signed (25%)"><span class="block text-4xs text-gray-500">PRS</span><span class="block text-xs font-bold">${dailyData.prSigned}</span></div>
                        </div>

                        <!-- Daily Class Score and Progress Bar -->
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-3xs font-semibold text-gray-700 leading-none">DCS: ${dailyDCS.toFixed(1)}%</span>
                            <div class="progress-bar-bg flex-grow ml-2">
                                <div class="h-full rounded-full transition-all duration-300 ${levelClass}-bg" style="width: ${dailyDCS.toFixed(1)}%;"></div>
                            </div>
                        </div>
                        
                        <!-- Action Indicator -->
                        <div class="text-4xs text-center mt-2 font-bold ${dailyData.exists ? 'text-green-600' : 'text-blue-500'}">
                            ${dailyData.exists ? '<i class="ph-check-circle-fill mr-1"></i>Reported' : actionText}
                        </div>
                    </button>
                </div>
            `;
        }
        
        // --- MODAL & UI UTILITIES ---

        /**
         * Displays a transient notification message.
         */
        function showNotification(message, type = 'info') {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            
            box.classList.remove('opacity-100', 'translate-x-0', 'bg-red-500', 'bg-green-500', 'bg-gray-800');
            box.classList.add('opacity-0', 'translate-x-full');

            if (type === 'error') {
                box.classList.add('bg-red-500');
            } else if (type === 'success') {
                box.classList.add('bg-green-500');
            } else {
                box.classList.add('bg-gray-800');
            }

            text.textContent = message;

            setTimeout(() => {
                box.classList.add('opacity-100', 'translate-x-0');
            }, 50); // Small delay to reset animation

            setTimeout(() => {
                box.classList.remove('opacity-100', 'translate-x-0');
                box.classList.add('opacity-0', 'translate-x-full');
            }, 4000);
        }

        /**
         * Opens a generic modal with a fade/scale animation.
         */
        function openModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            modal.classList.remove('hidden');
            // Force reflow to ensure transition starts
            void content.offsetWidth; 
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * Closes a generic modal with a fade/scale animation.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div:not([class*="fixed"])'); // Select the content wrapper

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Match transition duration
        }

        /**
         * Custom confirmation dialog, returns a promise.
         */
        function customConfirm(title, message, buttonText = 'Proceed') {
            return new Promise((resolve, reject) => {
                resolveConfirm = resolve;
                rejectConfirm = reject;

                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-action-button').textContent = buttonText;
                
                openModal('confirm-modal', 'confirm-content-wrapper');
            });
        }
        
        /** Resolves the current confirmation promise. */
        function confirmResolve() {
            closeModal('confirm-modal');
            if (resolveConfirm) resolveConfirm(true);
        }

        /** Rejects the current confirmation promise. */
        function confirmReject() {
            closeModal('confirm-modal');
            if (rejectConfirm) rejectConfirm(false);
        }

        // --- AUTHENTICATION HANDLERS ---
        
        /**
         * Updates the text and action of the auth button.
         */
        function updateAuthButton(text) {
            const button = document.getElementById('auth-button');
            const icon = button.querySelector('i');
            button.title = text;

            if (text === 'Sign In') {
                button.innerHTML = '<i class="ph-user-circle-fill text-xl"></i>';
                button.onclick = window.app.signInWithGoogle;
                button.classList.remove('bg-red-500');
                button.classList.add('bg-blue-500');
            } else {
                button.innerHTML = '<i class="ph-sign-out-fill text-xl"></i>';
                button.onclick = window.app.handleAuthClick;
                button.classList.remove('bg-blue-500');
                button.classList.add('bg-red-500');
            }
        }

        /**
         * Handles the click on the Auth button (Sign In or Sign Out).
         */
        async function handleAuthClick() {
            if (userId && !auth.currentUser.isAnonymous) {
                // User is signed in with Google
                try {
                    const result = await customConfirm('Sign Out', 'Are you sure you want to sign out?', 'Sign Out');
                    if (result) {
                        await signOut(auth);
                        showNotification('Signed out successfully. You are now signed in anonymously.', 'info');
                    }
                } catch (e) {
                    console.log("Sign out cancelled.");
                }
            } else if (userId && auth.currentUser.isAnonymous) {
                // User is signed in anonymously (or with initial token) - Copy User ID
                try {
                    // Use a temporary input element for copying due to iframe restrictions
                    const tempInput = document.createElement('input');
                    tempInput.value = userId;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showNotification('User ID copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    showNotification('Could not copy User ID.', 'error');
                }
            } else {
                // Not signed in - prompt for Google Sign In
                await signInWithGoogle();
            }
        }

        /**
         * Initiates Google Sign In.
         */
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showNotification('Signed in with Google successfully!', 'success');
            } catch (error) {
                console.error("Google Sign In Error:", error);
                showNotification(`Sign In Failed: ${error.message}`, 'error');
            }
        }

        // --- REPORT LOGIC ---

        let currentReportClassId = null;

        /**
         * Opens the modal for daily report entry.
         */
        function openReportModal(classId, className) {
            currentReportClassId = classId;
            const isToday = formatToISODate(selectedDate) === formatToISODate(new Date());

            document.getElementById('report-class-name').textContent = className;
            document.getElementById('report-date-display').textContent = selectedDate.toDateString();

            const submitButton = document.getElementById('report-submit-button');
            const deleteButton = document.getElementById('report-delete-button');
            const formInputs = document.querySelectorAll('#report-form input');

            // Find existing data for the selected class and date
            const data = dailyReports[classId] || { total: '', present: '', prBrought: '', prSigned: '', dcs: 0, exists: false };

            document.getElementById('report-total').value = data.total || '';
            document.getElementById('report-present').value = data.present || '';
            document.getElementById('report-pr-brought').value = data.prBrought || '';
            document.getElementById('report-pr-signed').value = data.prSigned || '';

            recalculateDCS();

            if (isToday) {
                // Enable inputs for today's entry/edit
                formInputs.forEach(input => input.disabled = false);
                submitButton.classList.remove('hidden');
                deleteButton.classList.add('hidden'); // Only show delete if data exists
                
                if (data.exists) {
                    document.getElementById('report-submit-text').textContent = 'Update Report';
                    deleteButton.classList.remove('hidden');
                } else {
                    document.getElementById('report-submit-text').textContent = 'Save Report';
                }
            } else {
                // Disable inputs for viewing historical data
                formInputs.forEach(input => input.disabled = true);
                submitButton.classList.add('hidden');
                deleteButton.classList.add('hidden');
            }

            openModal('report-modal', 'report-content-wrapper');
        }

        /**
         * Recalculates the Daily Class Score (DCS) based on current inputs.
         */
        function recalculateDCS() {
            const total = parseInt(document.getElementById('report-total').value) || 0;
            const present = parseInt(document.getElementById('report-present').value) || 0;
            const prBrought = parseInt(document.getElementById('report-pr-brought').value) || 0;
            const prSigned = parseInt(document.getElementById('report-pr-signed').value) || 0;
            const dcsDisplay = document.getElementById('report-dcs-display');
            const submitButton = document.getElementById('report-submit-button');
            const errorElement = document.getElementById('report-error-message');
            
            errorElement.classList.add('hidden');

            if (total === 0) {
                dcsDisplay.textContent = '0.0%';
                submitButton.disabled = true;
                if (present > 0 || prBrought > 0 || prSigned > 0) {
                    errorElement.textContent = "Total Students must be greater than 0 if other metrics are greater than 0.";
                    errorElement.classList.remove('hidden');
                } else if (document.getElementById('report-present').value !== '' && formatToISODate(selectedDate) === formatToISODate(new Date())) {
                    // Allow saving 0s if it's an empty submission
                    submitButton.disabled = false;
                }
                return;
            }

            if (present > total || prBrought > total || prSigned > total) {
                dcsDisplay.textContent = '0.0%';
                submitButton.disabled = true;
                errorElement.textContent = "Present, PR Brought, and PR Signed cannot exceed Total Students.";
                errorElement.classList.remove('hidden');
                return;
            }

            // Calculation: (Present/Total * 50%) + (PR Brought/Total * 25%) + (PR Signed/Total * 25%)
            const dcs = (present / total * 0.5 + prBrought / total * 0.25 + prSigned / total * 0.25) * 100;
            
            dcsDisplay.textContent = `${dcs.toFixed(1)}%`;
            submitButton.disabled = false;
        }

        /**
         * Saves or updates a daily report and updates accumulated scores using a transaction.
         */
        async function updateReportEntry() {
            if (!currentReportClassId) return;

            const submitButton = document.getElementById('report-submit-button');
            const submitText = document.getElementById('report-submit-text');
            const submitSpinner = document.getElementById('report-submit-spinner');
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            const classId = currentReportClassId;
            const total = parseInt(document.getElementById('report-total').value) || 0;
            const present = parseInt(document.getElementById('report-present').value) || 0;
            const prBrought = parseInt(document.getElementById('report-pr-brought').value) || 0;
            const prSigned = parseInt(document.getElementById('report-pr-signed').value) || 0;

            // Re-run validation one last time
            if (total < 0 || present < 0 || prBrought < 0 || prSigned < 0 || 
                present > total || prBrought > total || prSigned > total) {
                showNotification('Input error. Check the values.', 'error');
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                return;
            }

            const dcs = (total === 0 && (present > 0 || prBrought > 0 || prSigned > 0)) ? 0 : 
                        (total === 0) ? 0 : // Allow saving 0/0/0/0
                        (present / total * 0.5 + prBrought / total * 0.25 + prSigned / total * 0.25) * 100;

            const reportISO = formatToISODate(selectedDate);
            const reportDocRef = doc(db, `artifacts/${appId}/public/data/daily_attendance_reports/${reportISO}`);
            const accumulatedDocRef = doc(db, ACCUMULATED_COL_PATH, classId);
            
            const oldReport = dailyReports[classId] || { dcs: 0, exists: false };
            const newReport = { total, present, prBrought, prSigned, dcs, timestamp: serverTimestamp(), exists: true };

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Get the current accumulated score
                    const accumulatedSnap = await transaction.get(accumulatedDocRef);
                    const currentAccumulated = accumulatedSnap.data() || { totalScore: 0, daysCount: 0 };
                    
                    let newTotalScore = currentAccumulated.totalScore;
                    let newDaysCount = currentAccumulated.daysCount;
                    
                    // 2. Adjust accumulated score based on old report (if it existed)
                    if (oldReport.exists) {
                        // Subtract old score before adding new one
                        newTotalScore -= oldReport.dcs;
                    } else {
                        // This is a new day's entry
                        newDaysCount += 1;
                    }

                    // 3. Add the new score
                    newTotalScore += newReport.dcs;
                    
                    // 4. Calculate new average
                    const newAverageScore = newDaysCount > 0 ? newTotalScore / newDaysCount : 0;
                    
                    // 5. Update the Accumulated Score document
                    transaction.set(accumulatedDocRef, {
                        classId: classId,
                        totalScore: newTotalScore,
                        daysCount: newDaysCount,
                        averageScore: newAverageScore,
                        lastUpdate: serverTimestamp()
                    }, { merge: true });

                    // 6. Update the Daily Report document
                    transaction.set(reportDocRef, {
                        [classId]: newReport
                    }, { merge: true });
                });

                showNotification(oldReport.exists ? 'Report updated successfully!' : 'Report saved successfully!', 'success');
                closeModal('report-modal');

            } catch (e) {
                console.error("Transaction failed:", e);
                showNotification(`Save Failed: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        }

        /**
         * Deletes a daily report and updates accumulated scores using a transaction.
         */
        async function deleteReportEntry() {
            if (!currentReportClassId) return;

            const classId = currentReportClassId;
            const reportISO = formatToISODate(selectedDate);
            const reportDocRef = doc(db, `artifacts/${appId}/public/data/daily_attendance_reports/${reportISO}`);
            const accumulatedDocRef = doc(db, ACCUMULATED_COL_PATH, classId);
            
            const oldReport = dailyReports[classId] || { dcs: 0, exists: false };

            if (!oldReport.exists) {
                closeModal('report-modal');
                return;
            }

            try {
                const result = await customConfirm('Delete Report', `Are you sure you want to delete the report for ${reportISO}? This will update the class's average score.`, 'Delete');
                if (!result) return;
            } catch (e) {
                return; // Cancellation
            }

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Get the current accumulated score
                    const accumulatedSnap = await transaction.get(accumulatedDocRef);
                    const currentAccumulated = accumulatedSnap.data() || { totalScore: 0, daysCount: 0 };
                    
                    let newTotalScore = currentAccumulated.totalScore - oldReport.dcs;
                    let newDaysCount = currentAccumulated.daysCount - 1;
                    
                    // Prevent negative count/score
                    newTotalScore = Math.max(0, newTotalScore);
                    newDaysCount = Math.max(0, newDaysCount);
                    
                    // 2. Calculate new average
                    const newAverageScore = newDaysCount > 0 ? newTotalScore / newDaysCount : 0;
                    
                    // 3. Update the Accumulated Score document
                    transaction.set(accumulatedDocRef, {
                        classId: classId,
                        totalScore: newTotalScore,
                        daysCount: newDaysCount,
                        averageScore: newAverageScore,
                        lastUpdate: serverTimestamp()
                    }, { merge: true });

                    // 4. Update the Daily Report document to remove the field
                    transaction.update(reportDocRef, {
                        [classId]: deleteField()
                    });
                });

                showNotification('Report deleted successfully!', 'success');
                closeModal('report-modal');

            } catch (e) {
                console.error("Delete transaction failed:", e);
                showNotification(`Delete Failed: ${e.message}`, 'error');
            }
        }

        // --- CONFIG/SETTINGS LOGIC ---

        /**
         * Renders the department configuration list in the settings modal.
         */
        function renderDepartmentsInSettings() {
            const container = document.getElementById('departments-config-container');
            container.innerHTML = '';

            config.departments.forEach((dept, deptIndex) => {
                const deptDiv = document.createElement('div');
                deptDiv.id = `dept-config-${deptIndex}`;
                deptDiv.className = 'border border-gray-200 rounded-xl p-4 shadow-sm bg-gray-50';
                
                // Department Header and Name Input
                let deptHtml = `
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <input type="text" value="${dept.name}" oninput="window.app.updateDepartmentName(${deptIndex}, this.value)" 
                               class="text-lg font-bold p-1 bg-transparent border-none focus:ring-0 focus:border-blue-500 w-3/4" placeholder="Department Name">
                        <button onclick="window.app.removeDepartment(${deptIndex})" class="text-red-500 hover:text-red-700 transition" title="Remove Department">
                            <i class="ph-trash-fill text-xl"></i>
                        </button>
                    </div>
                    
                    <h5 class="text-base font-semibold text-gray-600 mb-2">Classes in ${dept.name}</h5>
                    <div id="classes-config-${deptIndex}" class="space-y-2 mb-4">
                `;
                
                // Class List
                dept.classes.forEach((cls, classIndex) => {
                    deptHtml += `
                        <div class="flex items-center space-x-2 bg-white p-2 rounded-lg border">
                            <input type="text" value="${cls.name}" oninput="window.app.updateClassName(${deptIndex}, ${classIndex}, this.value)" 
                                   class="flex-grow p-1 text-sm border border-gray-200 rounded-md focus:border-blue-500" placeholder="Class Name (e.g., 1A)">
                            <select onchange="window.app.updateClassType(${deptIndex}, ${classIndex}, this.value)" 
                                    class="p-1 text-sm border border-gray-200 rounded-md focus:border-blue-500 w-24">
                                <option value="Girls" ${cls.type === 'Girls' ? 'selected' : ''}>Girls</option>
                                <option value="Boys" ${cls.type === 'Boys' ? 'selected' : ''}>Boys</option>
                            </select>
                            <button onclick="window.app.removeClass(${deptIndex}, ${classIndex})" class="text-red-400 hover:text-red-600 transition" title="Remove Class">
                                <i class="ph-x-circle-fill text-lg"></i>
                            </button>
                        </div>
                    `;
                });

                // Add Class Button
                deptHtml += `
                    </div>
                    <button onclick="window.app.addClass(${deptIndex})" type="button" class="flex items-center space-x-1 px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition mt-2">
                        <i class="ph-plus text-lg"></i><span>Add Class</span>
                    </button>
                `;

                deptDiv.innerHTML = deptHtml;
                container.appendChild(deptDiv);
            });
        }
        
        /**
         * Adds a new department to the configuration.
         */
        function addDepartment() {
            // Department ID generated with a slice of timestamp for uniqueness on first creation
            config.departments.push({
                name: "New Department",
                id: generateSlug('New Department-' + Date.now().toString().slice(-4)),
                classes: []
            });
            renderDepartmentsInSettings();
        }

        /**
         * Removes a department from the configuration.
         */
        async function removeDepartment(deptIndex) {
            const deptName = config.departments[deptIndex].name;
            try {
                const result = await customConfirm('Remove Department', `Are you sure you want to remove the department: ${deptName}? This action cannot be undone.`, 'Remove');
                if (result) {
                    config.departments.splice(deptIndex, 1);
                    renderDepartmentsInSettings();
                    showNotification(`Department "${deptName}" removed. Don't forget to save!`, 'info');
                }
            } catch (e) {
                console.log("Removal cancelled.");
            }
        }

        /**
         * Updates the name of a department.
         * NOTE: We no longer update class IDs here, as they are now based on Class Name + Type only.
         */
        function updateDepartmentName(deptIndex, newName) {
            config.departments[deptIndex].name = newName;
            // Department ID is NOT updated on input change to avoid breaking existing links
        }

        /**
         * Adds a new class to a department.
         */
        function addClass(deptIndex) {
            const dept = config.departments[deptIndex];
            const newClassName = "New Class";
            const defaultType = 'Girls'; 
            // New class ID is based on Name and Type, plus a unique suffix to prevent immediate conflict
            const newClassId = generateSlug(newClassName + '-' + defaultType + '-' + Date.now().toString().slice(-4)); 

            dept.classes.push({
                name: newClassName,
                id: newClassId,
                type: defaultType 
            });
            renderDepartmentsInSettings();
        }

        /**
         * Removes a class from a department.
         */
        async function removeClass(deptIndex, classIndex) {
            const className = config.departments[deptIndex].classes[classIndex].name;
            try {
                const result = await customConfirm('Remove Class', `Are you sure you want to remove the class: ${className}? Accumulated data will remain in the database.`, 'Remove');
                if (result) {
                    config.departments[deptIndex].classes.splice(classIndex, 1);
                    renderDepartmentsInSettings();
                    showNotification(`Class "${className}" removed. Don't forget to save!`, 'info');
                }
            } catch (e) {
                console.log("Removal cancelled.");
            }
        }

        /**
         * Updates the name of a class and recalculates its ID using both name and type.
         * FIX: ID must incorporate class type to avoid duplicate slugs like '1a' for Boys and Girls.
         */
        function updateClassName(deptIndex, classIndex, newName) {
            const classType = config.departments[deptIndex].classes[classIndex].type;
            const newId = generateSlug(newName + '-' + classType); // New ID format: className-type
            
            config.departments[deptIndex].classes[classIndex].name = newName;
            config.departments[deptIndex].classes[classIndex].id = newId;
        }

        /**
         * Updates the type (Girls/Boys) of a class and recalculates its ID.
         * FIX: ID must incorporate class name to ensure uniqueness across sections.
         */
        function updateClassType(deptIndex, classIndex, newType) {
            const className = config.departments[deptIndex].classes[classIndex].name;
            const newId = generateSlug(className + '-' + newType); // New ID format: className-type
            
            config.departments[deptIndex].classes[classIndex].type = newType;
            config.departments[deptIndex].classes[classIndex].id = newId;
        }

        /**
         * Saves all configuration data and uploads the logo if necessary.
         */
        async function saveConfig() {
            const saveButton = document.getElementById('config-save-button');
            const saveText = document.getElementById('config-save-text');
            const saveSpinner = document.getElementById('config-save-spinner');
            const errorElement = document.getElementById('settings-error-message');

            if (!authReady || !userId || auth.currentUser.isAnonymous) {
                 errorElement.textContent = "You must be signed in with Google to save settings.";
                 errorElement.classList.remove('hidden');
                 return;
            }
            errorElement.classList.add('hidden');


            saveButton.disabled = true;
            saveText.classList.add('hidden');
            saveSpinner.classList.remove('hidden');

            const logoFile = document.getElementById('config-schoolLogo').files[0];
            const logoText = document.getElementById('config-schoolLogoText').value.trim().toUpperCase() || 'T.';
            
            let newLogoUrl = config.schoolInfo.logoUrl; // Preserve existing URL by default

            try {
                // 1. Validate required fields
                const schoolName = document.getElementById('config-schoolName').value.trim();
                if (!schoolName) throw new Error("School Name is required.");

                // Check for duplicate class IDs after slugification (Now correctly based on Name AND Type)
                const allClassIds = [];
                for (const dept of config.departments) {
                    for (const cls of dept.classes) {
                        // The ID should be unique, which now includes the type (e.g., '1a-girls' vs '1a-boys')
                        if (allClassIds.includes(cls.id)) {
                            throw new Error(`Duplicate class name/type found. Please ensure the combination of Class Name ("${cls.name}") and Section (${cls.type}) is unique across all classes. Slug: ${cls.id}`);
                        }
                        allClassIds.push(cls.id);
                    }
                }

                // 2. Handle Logo Upload/Delete
                if (logoFile) {
                    const storageRef = ref(storage, STORAGE_LOGO_PATH);
                    const snapshot = await uploadBytes(storageRef, logoFile);
                    newLogoUrl = await getDownloadURL(snapshot.ref);
                } else if (!logoFile && config.schoolInfo.logoUrl) {
                    // Check if logo input was cleared but an old URL exists. 
                    // Assume user wants to keep the old logo unless they explicitly delete it via a dedicated control (not implemented here) or by changing the file.
                }

                // 3. Prepare updated config object
                const updatedConfig = {
                    schoolInfo: {
                        name: schoolName,
                        address: document.getElementById('config-schoolAddress').value.trim(),
                        phone: document.getElementById('config-schoolPhone').value.trim(),
                        website: document.getElementById('config-schoolWebsite').value.trim(),
                        logoUrl: newLogoUrl,
                        logoText: logoText,
                    },
                    departments: config.departments.map(dept => ({
                        // Clean up department object for saving
                        name: dept.name,
                        id: dept.id,
                        classes: dept.classes.map(cls => ({ name: cls.name, id: cls.id, type: cls.type }))
                    }))
                };

                // 4. Save to Firestore
                const configDocRef = doc(db, CONFIG_DOC_PATH);
                await setDoc(configDocRef, updatedConfig);
                
                // Clear the file input after successful upload
                document.getElementById('config-schoolLogo').value = null;

                showNotification('Configuration saved successfully!', 'success');
                closeModal('settings-modal');

            } catch (e) {
                console.error("Config save failed:", e);
                errorElement.textContent = `Save Error: ${e.message}`;
                errorElement.classList.remove('hidden');
            } finally {
                saveButton.disabled = false;
                saveText.classList.remove('hidden');
                saveSpinner.classList.add('hidden');
            }
        }
        
        // --- HELPER FUNCTIONS ---

        /**
         * Generates a slug from a string (used for IDs).
         */
        function generateSlug(text) {
            return text
                .toString()
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')       // Replace spaces with -
                .replace(/[^\w\-]+/g, '')   // Remove all non-word chars
                .replace(/\-\-+/g, '-')     // Replace multiple - with single -
                .substring(0, 50);          // Truncate to a reasonable length
        }

        /**
         * Formats a Date object to YYYY-MM-DD string.
         */
        function formatToISODate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // --- PUBLIC API EXPOSURE ---
        const appInterface = {
            openModal: openModal,
            closeModal: closeModal,
            confirmResolve: confirmResolve,
            confirmReject: confirmReject,
            recalculateDCS: recalculateDCS,
            handleAuthClick: handleAuthClick,
            
            /** Opens the settings modal and prepares the configuration form. */
            openSettings: function() {
                const info = config.schoolInfo;
                document.getElementById('config-schoolName').value = info.name || '';
                document.getElementById('config-schoolAddress').value = info.address || '';
                document.getElementById('config-schoolPhone').value = info.phone || '';
                document.getElementById('config-schoolWebsite').value = info.website || '';
                document.getElementById('config-schoolLogoText').value = info.logoText || 'T.';
                document.getElementById('settings-error-message').classList.add('hidden');


                // Set up Logo Preview logic
                const fileInput = document.getElementById('config-schoolLogo');
                const previewImg = document.getElementById('school-logo-img');
                const previewText = document.getElementById('school-logo-text');

                // Initial state
                previewImg.src = info.logoUrl || '';
                if (info.logoUrl) {
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                } else {
                    previewImg.classList.add('hidden');
                    previewText.classList.remove('hidden');
                    previewText.textContent = info.logoText || 'T.';
                }
                
                // File input change listener for live preview
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            previewImg.classList.remove('hidden');
                            previewText.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else if (!info.logoUrl) {
                        // Revert to text if file cleared and no existing URL
                        previewImg.classList.add('hidden');
                        previewText.classList.remove('hidden');
                        previewText.textContent = document.getElementById('config-schoolLogoText').value.trim() || 'T.';
                    }
                };

                renderDepartmentsInSettings();
                this.openModal('settings-modal', 'settings-content-wrapper');
            },

            signInWithGoogle: signInWithGoogle,
            addDepartment: addDepartment,
            removeDepartment: removeDepartment,
            updateDepartmentName: updateDepartmentName,
            addClass: addClass,
            removeClass: removeClass,
            updateClassName: updateClassName,
            updateClassType: updateClassType,
            saveConfig: saveConfig,
            openReportModal: openReportModal,
            updateReportEntry: updateReportEntry,
            deleteReportEntry: deleteReportEntry,
        };

        window.app = appInterface; 

        // --- INITIAL SETUP ---
        
        // Use document.addEventListener('DOMContentLoaded', ...) instead of window.onload
        // to ensure it runs as soon as the DOM is ready.
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

    </script>
</body>
</html>
