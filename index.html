<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Firebase App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Basic icon style for delete button */
        .delete-btn {
            transition: color 0.1s;
        }
        .delete-btn:hover {
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen p-4 md:p-10 flex flex-col items-center">
        <header class="w-full max-w-4xl mb-8">
            <h1 class="text-4xl font-bold text-center text-indigo-700">Firestore & Google Auth Demo</h1>
        </header>

        <!-- Message Box -->
        <div id="message-box" class="w-full max-w-xl p-3 mb-4 rounded-lg text-center text-sm hidden"></div>

        <!-- Authentication and Status Section -->
        <div id="auth-status" class="w-full max-w-xl bg-white p-6 shadow-lg rounded-xl mb-8 border border-gray-100">
            <div id="loading-indicator" class="text-center text-gray-500">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Initializing Firebase...
            </div>
            
            <div id="logged-out-view" class="hidden text-center">
                <p class="text-gray-600 mb-4">Please sign in to view and contribute to the **shared notes**.</p>
                <button onclick="signInWithGoogle()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-1" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M22.001 12.185c0-.986-.098-1.92-.262-2.812H12.03v5.334h5.686c-.244 1.25-.89 2.457-1.84 3.486l-.001.002-4.008 3.097v.002h.003c2.723 0 5.25-1.07 7.147-3.003C21.436 16.594 22 14.484 22 12.185z" fill="#4285F4"/><path d="M12.03 22c3.23 0 5.92-1.066 7.892-2.887l-4.006-3.097c-1.12.722-2.557 1.148-3.886 1.148-2.986 0-5.51-2.007-6.425-4.706H1.54v.033C3.41 19.336 7.37 22 12.03 22z" fill="#34A853"/><path d="M5.605 13.911c-.24-.722-.375-1.488-.375-2.261 0-.773.135-1.538.375-2.26l-.002-.016H1.539v2.293c.725 3.09 3.553 5.418 6.577 5.418.995 0 1.94-.216 2.784-.582l-2.046-1.58C6.918 15.65 6.136 14.88 5.605 13.911z" fill="#FBBC05"/><path d="M12.03 6.94c1.652 0 3.085.674 4.234 1.764L19.53 5.093c-2.015-1.91-4.7-3.093-7.498-3.093C7.37 2 3.41 4.67 1.54 8.083h4.065c.915-2.698 3.439-4.706 6.425-4.706z" fill="#EA4335"/></svg>
                    Sign in with Google
                </button>
            </div>

            <div id="logged-in-view" class="hidden">
                <div class="flex flex-col md:flex-row items-center justify-between mb-4">
                    <p class="text-sm text-gray-500 mb-2 md:mb-0">Logged in as: <span id="user-display-name" class="font-semibold text-gray-700"></span></p>
                    <button onclick="signOutUser()" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Sign Out
                    </button>
                </div>
                <!-- Hidden element to store the actual UID, used for data saving and deletion checks -->
                <span id="user-id-display" class="hidden"></span>
                <hr class="mb-4">
                
                <!-- Notes Input Form -->
                <form id="note-form" class="space-y-4">
                    <textarea id="note-text" rows="3" placeholder="Write a new shared note here..." 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        Share Note
                    </button>
                </form>
            </div>
        </div>

        <!-- Notes Display Section -->
        <div id="notes-container" class="w-full max-w-xl hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Public Shared Notes</h2>
            <div id="notes-list" class="space-y-3">
                <p id="no-notes" class="text-gray-500 text-center py-4 border border-dashed border-gray-300 rounded-lg">No notes found. Add one above!</p>
                <!-- Notes will be inserted here -->
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =========================================================================
        // YOUR ACTUAL FIREBASE CONFIGURATION (Provided by the user)
        // =========================================================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCtsveJ8hmw6JJN4YlouNuHhmvSYumiMos", 
            authDomain: "classroom-chronicle-l6lhk.firebaseapp.com",
            projectId: "classroom-chronicle-l6lhk",
            storageBucket: "classroom-chronicle-l6lhk.firebasestorage.app",
            messagingSenderId: "642583297310",
            appId: "1:642583297310:web:fdb8da9ab0f01cd9aa9d0f"
        };
        // =========================================================================
        
        // Use environment variables if they exist, otherwise fall back to the hardcoded config
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : FIREBASE_CONFIG.projectId;
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG;
        const envInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const appId = envAppId || 'default-app-id'; 
        const firebaseConfig = envFirebaseConfig;
        const initialAuthToken = envInitialAuthToken; 

        let db, auth, userId = null;
        let userName = null; // New variable to store display name
        let userEmail = null; // New variable to store email
        let unsubscribeNotes = () => {}; // Placeholder for the unsubscribe function

        const loadingIndicator = document.getElementById('loading-indicator');
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');
        const notesContainer = document.getElementById('notes-container');
        const notesList = document.getElementById('notes-list');
        const noteForm = document.getElementById('note-form');
        const noteText = document.getElementById('note-text');
        // We now update a separate element for the display name
        const userIdDisplay = document.getElementById('user-id-display'); 
        const userDisplayName = document.getElementById('user-display-name');
        const messageBox = document.getElementById('message-box');
        const noNotesMessage = document.getElementById('no-notes');

        // --- Utility Functions ---

        /**
         * Displays a message in the message box.
         * @param {string} msg - The message to display.
         * @param {('success'|'error'|'info')} type - The type of message.
         */
        function showMessage(msg, type = 'info') {
            let bgColor = 'bg-blue-100 border-blue-400 text-blue-700';
            if (type === 'error') bgColor = 'bg-red-100 border-red-400 text-red-700';
            if (type === 'success') bgColor = 'bg-green-100 border-green-400 text-green-700';

            messageBox.textContent = msg;
            messageBox.className = `w-full max-w-xl p-3 mb-4 rounded-lg text-center text-sm border ${bgColor}`;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        /**
         * Gets the Firestore collection reference for the shared public notes.
         * @returns {import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").CollectionReference}
         */
        function getNoteCollectionRef() {
            if (!db) {
                console.error("Database is not ready.");
                return null;
            }
            // Public data path: /artifacts/{appId}/public/data/shared_notes
            return collection(db, `artifacts/${appId}/public/data/shared_notes`);
        }

        /** Signs in with Google using a popup. */
        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                // Request the profile scope to get name and picture
                provider.addScope('profile'); 
                provider.addScope('email');
                
                await signInWithPopup(auth, provider);
                showMessage("Successfully signed in with Google!", 'success');
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                
                let userMessage = `Google Sign-In failed: ${error.message}`;
                
                if (error.code === 'auth/unauthorized-domain') {
                    userMessage = "Sign-In Failed: The current domain is not authorized. Please add this application's domain (e.g., 'localhost' or your deployed URL) to the 'Authorized domains' list in your Firebase Console under **Authentication > Settings**.";
                }

                showMessage(userMessage, 'error');
            }
        }

        /** Signs out the current user. */
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                showMessage("Successfully signed out.", 'info');
            } catch (error) {
                console.error("Sign-out Error:", error);
                showMessage(`Sign-out failed: ${error.message}`, 'error');
            }
        }

        /**
         * Main function to initialize Firebase and handle initial authentication.
         */
        async function initializeAppAndAuth() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                loadingIndicator.textContent = "Error: Firebase configuration is invalid or missing keys.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                loadingIndicator.style.display = 'block';
                
                // Use initialAuthToken if available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 

                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.style.display = 'none';

                    if (user) {
                        userId = user.uid;
                        // Capture Name and Email for display and storage
                        userName = user.displayName || 'Anonymous User';
                        userEmail = user.email || 'No Email Provided';

                        // Update UI to show name/email
                        userDisplayName.textContent = userName + (user.email ? ` (${user.email})` : '');
                        userIdDisplay.textContent = userId; // Keep UID hidden for internal use

                        loggedOutView.classList.add('hidden');
                        loggedInView.classList.remove('hidden');
                        notesContainer.classList.remove('hidden');
                        
                        setupRealtimeListener();

                    } else {
                        userId = null;
                        userName = null;
                        userEmail = null;
                        userDisplayName.textContent = 'N/A';
                        userIdDisplay.textContent = 'N/A';
                        loggedOutView.classList.remove('hidden');
                        loggedInView.classList.add('hidden');
                        notesContainer.classList.add('hidden');

                        unsubscribeNotes();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingIndicator.textContent = `Initialization Error: ${error.message}`;
            }
        }
        
        /** Adds a new note to the public shared collection, including name/email. */
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = noteText.value.trim();

            if (!text) {
                showMessage("Note cannot be empty.", 'info');
                return;
            }

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showMessage("Please sign in to share a note.", 'error');
                return;
            }

            const notesColRef = getNoteCollectionRef();
            if (!notesColRef) return;

            try {
                await addDoc(notesColRef, {
                    text: text,
                    createdAt: serverTimestamp(),
                    // Save user identifying information with the note
                    userId: userId,
                    userName: userName,
                    userEmail: userEmail
                });
                noteText.value = '';
                showMessage("Note shared successfully with everyone!", 'success');
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage(`Failed to share note: ${error.message}. Check your security rules for public write access.`, 'error');
            }
        });

        /** Deletes a note from the public shared collection. */
        window.deleteNote = async function(noteId) {
            if (!auth.currentUser || auth.currentUser.uid !== userId) {
                showMessage("You can only delete your own notes.", 'error');
                return;
            }

            try {
                const noteRef = doc(db, `artifacts/${appId}/public/data/shared_notes`, noteId);
                await deleteDoc(noteRef);
                showMessage("Note deleted!", 'success');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showMessage(`Failed to delete note: ${error.message}.`, 'error');
            }
        }

        /**
         * Sets up the real-time listener for the public shared notes.
         */
        function setupRealtimeListener() {
            unsubscribeNotes(); 
            notesList.innerHTML = '';
            noNotesMessage.classList.add('hidden');

            const notesColRef = getNoteCollectionRef();
            if (!notesColRef) return;

            const q = query(notesColRef); 

            unsubscribeNotes = onSnapshot(q, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => {
                    notes.push({ id: doc.id, ...doc.data() });
                });

                notes.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderNotes(notes);

            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                showMessage(`Error fetching notes: ${error.message}. **Please check your Firestore security rules for public read access.**`, 'error');
                renderNotes([]); 
            });
        }
        
        /**
         * Renders the list of notes to the UI.
         * @param {Array<Object>} notes - The array of note objects.
         */
        function renderNotes(notes) {
            notesList.innerHTML = ''; 

            if (notes.length === 0) {
                noNotesMessage.classList.remove('hidden');
                return;
            }
            noNotesMessage.classList.add('hidden');


            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'bg-white p-4 shadow-sm rounded-lg border border-gray-100 hover:shadow-md transition duration-150';
                
                let dateStr = 'Pending...';
                if (note.createdAt && note.createdAt.toDate) {
                    dateStr = note.createdAt.toDate().toLocaleString();
                }
                
                // Display Name or Email if available, fallback to UID
                const contributorName = note.userName || note.userEmail || note.userId || 'Unknown User';
                const contributorId = note.userId || 'Unknown User';
                const isOwner = userId && userId === contributorId;

                const deleteButton = isOwner ? `
                    <button onclick="deleteNote('${note.id}')" title="Delete your note" class="text-gray-400 hover:text-red-500 ml-3 delete-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.42c-.296.06-.59.13-.88.211L4.62 5H3.75A.75.75 0 0 0 3 5.75v.5c0 .192.126.353.304.416l.87.29a24.582 24.582 0 0 0 4.167 4.167l.29.87c.063.178.224.304.417.304h.5c.192 0 .353-.126.416-.304l.29-.87a24.582 24.582 0 0 0 4.167-4.167l.87-.29c.178-.063.304-.224.304-.416v-.5a.75.75 0 0 0-.75-.75h-.87l-.5-1.42c-.29-.081-.584-.151-.88-.21V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM1.5 6.75a.75.75 0 0 1 1.5 0v10.5a2 2 0 0 0 2 2h10.5a2 2 0 0 0 2-2V6.75a.75.75 0 0 1 1.5 0v10.5a3.5 3.5 0 0 1-3.5 3.5H5.5a3.5 3.5 0 0 1-3.5-3.5V6.75ZM8.75 3a1.25 1.25 0 0 1 1.25 1.25v.75H8.75v-.75A1.25 1.25 0 0 1 10 3.75v.42c-.296.06-.59.13-.88.211L4.62 5h10.76l-4.25-1.25H11.25Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                ` : '';

                noteElement.innerHTML = `
                    <p class="text-gray-800 whitespace-pre-wrap">${note.text}</p>
                    <div class="mt-2 flex flex-col md:flex-row justify-between items-start md:items-center text-xs text-gray-400">
                        <span>Saved: ${dateStr}</span>
                        <div class="flex items-center">
                            <span class="mt-1 md:mt-0">By: <span class="font-semibold text-gray-500">${contributorName}</span></span>
                            ${deleteButton}
                        </div>
                    </div>
                `;
                notesList.appendChild(noteElement);
            });
        }

        // --- Start the Application ---
        window.addEventListener('load', initializeAppAndAuth);

    </script>
</body>
</html>
